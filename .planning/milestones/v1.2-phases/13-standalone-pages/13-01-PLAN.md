---
phase: 13-standalone-pages
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/pages/heatmap.html
  - src/pages/pinmap.html
  - src/pages/routes.html
  - vite.config.pages.ts
  - scripts/build-widgets.mjs
  - dist/widgets/index.html
autonomous: true
requirements:
  - PAGE-01
  - PAGE-02
  - PAGE-03

must_haves:
  truths:
    - "User can view heatmap as a full standalone page at heatmap.html"
    - "User can view pin map as a full standalone page at pinmap.html"
    - "User can view route browser as a full standalone page at routes.html"
    - "Standalone pages load existing widget IIFE bundles (no code duplication)"
    - "Navigation links allow moving between standalone pages and widget index"
  artifacts:
    - path: "src/pages/heatmap.html"
      provides: "Standalone heatmap page template"
      contains: "heatmap-widget"
    - path: "src/pages/pinmap.html"
      provides: "Standalone pin map page template"
      contains: "pin-map-widget"
    - path: "src/pages/routes.html"
      provides: "Standalone route browser page template"
      contains: "route-browser"
    - path: "vite.config.pages.ts"
      provides: "Vite multi-page build configuration"
      contains: "rollupOptions"
  key_links:
    - from: "src/pages/heatmap.html"
      to: "heatmap-widget.iife.js"
      via: "script src reference"
      pattern: "heatmap-widget\\.iife\\.js"
    - from: "src/pages/pinmap.html"
      to: "pin-map-widget.iife.js"
      via: "script src reference"
      pattern: "pin-map-widget\\.iife\\.js"
    - from: "src/pages/routes.html"
      to: "route-browser.iife.js"
      via: "script src reference"
      pattern: "route-browser\\.iife\\.js"
    - from: "scripts/build-widgets.mjs"
      to: "vite.config.pages.ts"
      via: "page build step after widget build"
      pattern: "build-pages\\|vite\\.config\\.pages"
---

<objective>
Create full-page standalone versions of the heatmap, pin map, and route browser widgets for dedicated viewing at their own URLs, with a shared navigation bar and full-viewport map layouts.

Purpose: Users need dedicated pages for map visualizations (not just embedded widgets) so they can view maps at full viewport size with their own URLs for sharing and bookmarking.

Output: Three standalone HTML pages (heatmap.html, pinmap.html, routes.html) deployed alongside existing widget bundles, a Vite multi-page build config, and updated build script with navigation links.
</objective>

<execution_context>
@/Users/pedf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pedf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-standalone-pages/13-RESEARCH.md

# Key references for widget tag names and data URLs:
@src/widgets/heatmap-widget/index.ts — registered as 'heatmap-widget', default dataUrl: 'data/heatmap/all-points.json', accepts data-height, data-color-scheme
@src/widgets/pin-map-widget/index.ts — registered as 'pin-map-widget', fetches data/geo/cities.json, countries.json, location-cache.json, activity-cities.json, data/routes/route-list.json; accepts data-view
@src/widgets/route-browser/index.ts — registered as 'route-browser', default dataUrl: 'data/routes/route-list.json'
@scripts/build-widgets.mjs — current build script, builds all IIFE bundles and copies data files
@dist/widgets/index.html — current landing page, needs navigation links to standalone pages
@dist/widgets/test.html — reference for Leaflet CDN loading pattern (leaflet@1.9.4 CSS + JS, leaflet.heat CDN)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create standalone HTML pages and Vite build config</name>
  <files>
    src/pages/heatmap.html
    src/pages/pinmap.html
    src/pages/routes.html
    vite.config.pages.ts
  </files>
  <action>
Create `src/pages/` directory and three standalone HTML page templates.

**Each page follows this pattern:**
- DOCTYPE html with UTF-8 charset and responsive viewport meta
- Title: "[Page Name] — Strava Analytics"
- Leaflet CDN: `https://unpkg.com/leaflet@1.9.4/dist/leaflet.css` and `leaflet.js` (MUST match version used by widgets)
- For heatmap page ONLY: also load `https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js`
- Full-viewport CSS: `html, body { margin: 0; padding: 0; height: 100dvh; overflow: hidden; }` with `@supports not (height: 100dvh) { html, body { height: 100vh; } }` fallback
- Navigation bar: `<nav>` absolutely positioned (top: 12px, left: 12px, z-index: 1000), white background, border-radius 6px, box-shadow, containing links to: index.html ("Widgets"), heatmap.html ("Heatmap"), pinmap.html ("Pin Map"), routes.html ("Routes"). Active page link styled with Strava orange (#fc4c02).
- Widget element filling 100% width and height, with `data-max-width="none"` and `data-padding="0"` to remove WidgetBase's default 800px max-width and 20px padding
- Script tag loading the corresponding IIFE bundle from same directory (relative path `./`)

**heatmap.html specifics:**
- Widget tag: `<heatmap-widget data-height="100%" data-max-width="none" data-padding="0"></heatmap-widget>`
- Bundle: `./heatmap-widget.iife.js`
- Extra CDN: leaflet.heat

**pinmap.html specifics:**
- Widget tag: `<pin-map-widget data-max-width="none" data-padding="0"></pin-map-widget>`
- Bundle: `./pin-map-widget.iife.js`
- No extra CDN (markercluster is bundled within widget)

**routes.html specifics:**
- Widget tag: `<route-browser data-max-width="none" data-padding="0"></route-browser>`
- Bundle: `./route-browser.iife.js`

**vite.config.pages.ts:**
Create a Vite config for building pages using `defineConfig`:
```typescript
import { defineConfig } from 'vite';
import { resolve } from 'path';

export default defineConfig({
  build: {
    outDir: 'dist/widgets',
    emptyDir: false,  // CRITICAL: Do not delete widget bundles
    rollupOptions: {
      input: {
        heatmap: resolve(__dirname, 'src/pages/heatmap.html'),
        pinmap: resolve(__dirname, 'src/pages/pinmap.html'),
        routes: resolve(__dirname, 'src/pages/routes.html'),
      },
    },
    target: 'es2020',
    minify: 'terser',
  },
});
```

Note: The pages are pure HTML with no JS imports — Vite will just copy/minify them to dist/widgets/. The `emptyDir: false` is critical to avoid wiping out widget IIFE bundles already built.
  </action>
  <verify>
    Run `ls src/pages/` to confirm all 3 HTML files exist. Run `npx vite build --config vite.config.pages.ts` and verify it outputs to dist/widgets/ without deleting existing files. Check `ls dist/widgets/heatmap.html dist/widgets/pinmap.html dist/widgets/routes.html` to confirm pages were built.
  </verify>
  <done>
    Three standalone HTML pages exist in src/pages/, Vite config builds them to dist/widgets/ alongside existing bundles. Each page loads Leaflet CDN, contains a nav bar, and instantiates the correct widget element with full-viewport sizing.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate page build into build script and update navigation</name>
  <files>
    scripts/build-widgets.mjs
    dist/widgets/index.html
  </files>
  <action>
**Update scripts/build-widgets.mjs:**
After the `buildAllWidgets()` function completes (after `copyDataFiles()`), add a page build step that invokes Vite with the pages config. Import `build` from 'vite' (already imported) and add a `buildPages()` function:

```javascript
async function buildPages() {
  console.log('\nBuilding standalone pages...');
  const { default: pagesConfig } = await import('../vite.config.pages.ts');
  // Vite can import TS config natively
  await build(pagesConfig);
  console.log('✓ Built standalone pages (heatmap.html, pinmap.html, routes.html)');
}
```

Actually, simpler approach: use `build()` with inline config matching vite.config.pages.ts rather than importing the config file, to avoid TS import issues in a .mjs file:

```javascript
async function buildPages() {
  console.log('\nBuilding standalone pages...');
  await build({
    build: {
      outDir: 'dist/widgets',
      emptyDir: false,
      rollupOptions: {
        input: {
          heatmap: resolve(__dirname, '../src/pages/heatmap.html'),
          pinmap: resolve(__dirname, '../src/pages/pinmap.html'),
          routes: resolve(__dirname, '../src/pages/routes.html'),
        },
      },
      target: 'es2020',
      minify: 'terser',
    },
    logLevel: 'warn',
  });
  console.log('✓ Built standalone pages (heatmap.html, pinmap.html, routes.html)');
}
```

Call `buildPages()` at the end of `buildAllWidgets()`, after `copyDataFiles()` and before the final log.

**Update dist/widgets/index.html:**
Add navigation links to the standalone pages. In the `.footer` section (before the closing `</div>` of footer), add links:

```html
<p>
  <a href="heatmap.html">Heatmap</a> |
  <a href="pinmap.html">Pin Map</a> |
  <a href="routes.html">Route Browser</a>
</p>
```

Also add a "Standalone Maps" section before the footer with brief descriptions:

```html
<div class="widget">
  <h2>Standalone Map Pages</h2>
  <p>Full-page interactive map visualizations for dedicated viewing.</p>
  <ul style="list-style: none; padding: 0;">
    <li style="margin-bottom: 0.5rem;"><a href="heatmap.html" style="color: #fc4c02; text-decoration: none; font-weight: 500;">Heatmap</a> — All runs visualized as a density heatmap</li>
    <li style="margin-bottom: 0.5rem;"><a href="pinmap.html" style="color: #fc4c02; text-decoration: none; font-weight: 500;">Pin Map</a> — Cities and countries visited with interactive pins</li>
    <li style="margin-bottom: 0.5rem;"><a href="routes.html" style="color: #fc4c02; text-decoration: none; font-weight: 500;">Route Browser</a> — Browse and view individual run routes</li>
  </ul>
</div>
```
  </action>
  <verify>
    Run `node scripts/build-widgets.mjs` and confirm output includes "Built standalone pages" log line. Verify `ls dist/widgets/heatmap.html dist/widgets/pinmap.html dist/widgets/routes.html` shows all 3 pages alongside existing IIFE bundles (`ls dist/widgets/*.iife.js | wc -l` should show 11 bundles still present). Open dist/widgets/index.html in a browser and confirm standalone map links appear. Open each standalone page and verify the widget renders full-viewport with navigation.
  </verify>
  <done>
    Build script produces standalone pages alongside widget bundles in a single `npm run build-widgets` command. Index.html has navigation links to all three standalone pages. Full end-to-end build works: widgets, data, and pages all deployed together.
  </done>
</task>

</tasks>

<verification>
1. `npm run build-widgets` succeeds and produces dist/widgets/ containing:
   - All 11 IIFE widget bundles (*.iife.js)
   - All data JSON files (data/stats/, data/geo/, data/routes/, data/heatmap/)
   - index.html with standalone page links
   - heatmap.html, pinmap.html, routes.html standalone pages
2. Each standalone page contains: Leaflet CDN references, nav bar with links, widget element with full-viewport sizing, IIFE bundle script tag
3. No widget code is duplicated in standalone pages — they only reference existing IIFE bundles via script src
4. Navigation between pages works (relative .html links)
</verification>

<success_criteria>
- Three standalone HTML pages (heatmap.html, pinmap.html, routes.html) deployed to dist/widgets/
- Each page loads the corresponding widget at full viewport size with no scrolling
- Navigation bar on each page links to all other pages and the widget index
- Build script produces pages alongside widget bundles in a single command
- No new dependencies added
- Widget IIFE bundles are loaded (not duplicated) by standalone pages
</success_criteria>

<output>
After completion, create `.planning/phases/13-standalone-pages/13-01-SUMMARY.md`
</output>

---
phase: 11-route-map-widgets
plan: 03
type: execute
wave: 2
depends_on: [11-01]
files_modified:
  - src/widgets/route-browser/index.ts
  - scripts/build-widgets.mjs
autonomous: true
requirements: [ROUTE-02, ROUTE-04, ROUTE-05]

must_haves:
  truths:
    - "User can browse a scrollable list of runs sorted by date"
    - "User can select a run from the list to view its route on the map"
    - "Selected route auto-fits to viewport"
    - "User can click the displayed route to see distance, date, and pace"
  artifacts:
    - path: "src/widgets/route-browser/index.ts"
      provides: "Route browser widget with list + map side-by-side"
      min_lines: 120
  key_links:
    - from: "src/widgets/route-browser/index.ts"
      to: "src/widgets/shared/route-utils.ts"
      via: "RouteRenderer.renderRoute() for selected activity"
      pattern: "RouteRenderer\\.renderRoute"
    - from: "src/widgets/route-browser/index.ts"
      to: "data/routes/route-list.json"
      via: "fetchData for browseable activity list"
      pattern: "route-list\\.json"
---

<objective>
Build the route browser widget that lets users browse and select runs to view on an interactive map.

Purpose: ROUTE-02 (browse and select runs), ROUTE-04 (auto-fit on selection), ROUTE-05 (click popup with metadata). This is the most complex widget in Phase 11 — it combines a scrollable activity list with an embedded map, managing selection state and route transitions.

Output:
- `src/widgets/route-browser/index.ts` — `<route-browser>` Custom Element with list + map layout
- Updated `scripts/build-widgets.mjs` with new widget entry
</objective>

<execution_context>
@/Users/pedf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pedf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-route-map-widgets/11-RESEARCH.md
@.planning/phases/11-route-map-widgets/11-01-SUMMARY.md
@src/widgets/shared/widget-base.ts
@src/widgets/shared/route-utils.ts
@src/widgets/map-test-widget/index.ts
@src/widgets/geo-table-widget/index.ts
@scripts/build-widgets.mjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create route browser widget with list selection and embedded map</name>
  <files>src/widgets/route-browser/index.ts, scripts/build-widgets.mjs</files>
  <action>
Create `src/widgets/route-browser/index.ts`:

**RouteBrowserElement** extends WidgetBase. Displays a scrollable list of runs alongside an embedded map, updating the map when a run is selected.

**Imports** (map widget pattern):
```typescript
import L from 'leaflet';
import 'leaflet/dist/leaflet.css';
import { WidgetBase } from '../shared/widget-base.js';
import { RouteRenderer, RouteData } from '../shared/route-utils.js';
import markerIcon from 'leaflet/dist/images/marker-icon.png';
import markerIcon2x from 'leaflet/dist/images/marker-icon-2x.png';
import markerShadow from 'leaflet/dist/images/marker-shadow.png';
```

**Marker icon fix** (same pattern as other map widgets).

**Instance properties:**
- `private map: L.Map | null = null`
- `private currentPolyline: L.Polyline | null = null`
- `private routes: RouteData[] = []`
- `private selectedId: number | null = null`

**Widget config:**
- `dataUrl` returns `'data/routes/route-list.json'`
- `data-height` attribute: total widget height (default '500px')

**render(data: RouteData[]):**

1. Store `this.routes = data`
2. Clear shadow DOM except styles
3. Create a `<style>` element with widget-specific CSS (use constructible stylesheets or inline):

```css
.route-browser {
  display: grid;
  grid-template-columns: 280px 1fr;
  height: var(--browser-height, 500px);
  border: 1px solid var(--widget-border, #e0e0e0);
  border-radius: 8px;
  overflow: hidden;
}
.route-list {
  overflow-y: auto;
  border-right: 1px solid var(--widget-border, #e0e0e0);
  background: var(--widget-bg, #fff);
}
.route-list-item {
  padding: 12px 16px;
  border-bottom: 1px solid #f0f0f0;
  cursor: pointer;
  transition: background 0.15s;
}
.route-list-item:hover {
  background: #f5f5f5;
}
.route-list-item.selected {
  background: #fc4c02;
  color: white;
}
.route-list-item.selected .item-meta {
  color: rgba(255,255,255,0.8);
}
.item-name {
  font-weight: 600;
  font-size: 14px;
  margin-bottom: 2px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.item-meta {
  font-size: 12px;
  color: #666;
}
.route-map {
  min-height: 300px;
}
/* Responsive: stack on narrow containers */
@container widget (max-width: 500px) {
  .route-browser {
    grid-template-columns: 1fr;
    grid-template-rows: 200px 1fr;
  }
  .route-list {
    border-right: none;
    border-bottom: 1px solid var(--widget-border, #e0e0e0);
  }
}
```

4. Create container div with class `route-browser`. Set CSS variable `--browser-height` from `data-height` attribute.

5. Create list div with class `route-list`. For each route in data:
   - Create div with class `route-list-item`, set `data-id` attribute to route.id
   - Inner HTML: `<div class="item-name">${route.name}</div><div class="item-meta">${distanceKm} km &bull; ${formattedDate}</div>`
   - Format distance as `(route.distance / 1000).toFixed(1)`
   - Format date as `new Date(route.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })`
   - Add click event listener calling `this.selectRoute(route.id)`

6. Create map div with class `route-map`.

7. Append list and map divs to container, append container to shadow DOM.

8. Initialize Leaflet map on map div with default view [55.6761, 12.5683], zoom 10.
   Add OpenStreetMap tile layer with attribution and maxZoom 19.

9. Auto-select first route: `if (data.length > 0) this.selectRoute(data[0].id)`

**selectRoute(activityId: number):**
1. Find route in `this.routes` by id
2. If not found or no map, return
3. Remove current polyline if exists (`this.currentPolyline.remove()`)
4. Set `this.selectedId = activityId`
5. Render route: `this.currentPolyline = RouteRenderer.renderRoute(this.map, route, { showPopup: true, fitBounds: true })`
6. Add hover effect: `RouteRenderer.addHoverEffect(this.currentPolyline)`
7. Update list selection visual state:
   - Query all `.route-list-item` in shadow DOM
   - Remove `selected` class from all
   - Add `selected` class to item with matching `data-id`
   - Scroll selected item into view: `selectedItem.scrollIntoView({ block: 'nearest', behavior: 'smooth' })`

**disconnectedCallback():**
- Remove currentPolyline if exists
- Call map.remove() if map exists, set to null
- Call super.disconnectedCallback()

**Register:** `WidgetBase.register('route-browser', RouteBrowserElement)`

**Add to build-widgets.mjs** widgets array:
```javascript
{
  name: 'route-browser',
  entry: resolve(__dirname, '../src/widgets/route-browser/index.ts'),
  globalName: 'RouteBrowser',
  isMapWidget: true
}
```
  </action>
  <verify>
Run: `npx tsc --noEmit` — compiles without errors
Run: `npm run build-widgets` — builds successfully, dist/widgets/route-browser.iife.js exists and is < 50KB
Verify: All existing widget bundles still build correctly
Verify: Bundle ends with `}(L);` confirming Leaflet externalization
  </verify>
  <done>Route browser widget renders scrollable activity list alongside embedded map, selection updates displayed route with auto-fit and popup, responsive layout stacks vertically on narrow containers</done>
</task>

<task type="auto">
  <name>Task 2: Update test page and verify all Phase 11 widgets build correctly</name>
  <files>index.html</files>
  <action>
Update `index.html` to add embed examples for all three new route widgets. Add after existing widget sections:

1. Add Leaflet CDN in `<head>` if not already present (should be there from Phase 10 map-test-widget):
```html
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
```

2. Add widget script tags for the three new widgets:
```html
<script src="dist/widgets/single-run-map.iife.js"></script>
<script src="dist/widgets/multi-run-overlay.iife.js"></script>
<script src="dist/widgets/route-browser.iife.js"></script>
```

3. Add widget embed examples in the page body:
```html
<h2>Single Run Map</h2>
<single-run-map
  data-url="data/routes/route-list.json"
  data-activity-id="FIRST_ACTIVITY_ID"
  data-height="400px">
</single-run-map>

<h2>Multi-Run Overlay (Latest 10)</h2>
<multi-run-overlay
  data-url="data/routes/latest-runs.json"
  data-count="10"
  data-height="500px">
</multi-run-overlay>

<h2>Route Browser</h2>
<route-browser
  data-url="data/routes/route-list.json"
  data-height="500px">
</route-browser>
```

For `data-activity-id`, read the first entry's id from `data/routes/route-list.json` and use that value.

Run the full build to verify everything works:
- `npm run build-widgets` — all 9 widgets (6 existing + 3 new) build
- Verify all IIFE bundles exist in dist/widgets/
- Verify data/routes/*.json copied to dist/widgets/data/routes/
- `npm test` — no regressions
  </action>
  <verify>
Run: `npm run build-widgets` — 9 widgets build successfully
Run: `npm test` — all tests pass
Verify dist/widgets/ contains: single-run-map.iife.js, multi-run-overlay.iife.js, route-browser.iife.js
Verify dist/widgets/data/routes/ contains: route-list.json, latest-runs.json
  </verify>
  <done>All Phase 11 widgets build and deploy correctly, test page updated with embed examples, existing widgets unaffected</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes (all TypeScript compiles)
2. `npm run build-widgets` builds 9 widgets without errors
3. dist/widgets/route-browser.iife.js exists and < 50KB
4. dist/widgets/data/routes/route-list.json and latest-runs.json deployed
5. `npm test` passes (no regressions)
6. index.html contains embed examples for all three route widgets
</verification>

<success_criteria>
- `<route-browser>` shows scrollable list of runs with name, distance, date
- Clicking a list item updates the map to show that run's route
- Selected route auto-fits to viewport
- Clicking the route polyline shows popup with distance, date, pace
- Layout is side-by-side on wide containers, stacked on narrow (< 500px)
- All 9 widgets build correctly with existing widgets unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/11-route-map-widgets/11-03-SUMMARY.md`
</output>

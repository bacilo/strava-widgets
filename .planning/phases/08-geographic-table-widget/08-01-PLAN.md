---
phase: 08-geographic-table-widget
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/widgets/geo-table-widget/table-sorter.ts
  - src/widgets/geo-table-widget/table-paginator.ts
  - src/widgets/geo-table-widget/index.ts
autonomous: true

must_haves:
  truths:
    - "Table widget renders geographic data with sortable column headers"
    - "Clicking a column header sorts the table by that column (ascending/descending toggle)"
    - "Table paginates when rows exceed data-rows-per-page (default 20, clamped 1-50)"
    - "Sort indicators (arrows) show current sort column and direction"
    - "Widget supports both countries and cities datasets via data-dataset attribute"
  artifacts:
    - path: "src/widgets/geo-table-widget/table-sorter.ts"
      provides: "Locale-aware sorting with Intl.Collator for strings, numeric comparison for numbers"
      exports: ["TableSorter"]
    - path: "src/widgets/geo-table-widget/table-paginator.ts"
      provides: "Pagination state management with page navigation"
      exports: ["TablePaginator"]
    - path: "src/widgets/geo-table-widget/index.ts"
      provides: "Custom Element geo-table widget with Shadow DOM, sorting, pagination, accessibility"
      contains: "customElements.define"
  key_links:
    - from: "src/widgets/geo-table-widget/index.ts"
      to: "src/widgets/geo-table-widget/table-sorter.ts"
      via: "import TableSorter"
      pattern: "TableSorter\\.sort"
    - from: "src/widgets/geo-table-widget/index.ts"
      to: "src/widgets/geo-table-widget/table-paginator.ts"
      via: "import TablePaginator"
      pattern: "paginator\\.paginate"
    - from: "src/widgets/geo-table-widget/index.ts"
      to: "src/widgets/shared/widget-base.ts"
      via: "extends WidgetBase"
      pattern: "extends WidgetBase"
---

<objective>
Create the geographic table widget with sortable columns and pagination.

Purpose: Provides a standalone, embeddable table widget for geographic running statistics with accessible sorting and pagination for performance.
Output: Three new files implementing TableSorter utility, TablePaginator utility, and GeoTableWidget Custom Element.
</objective>

<execution_context>
@/Users/pedf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pedf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-geographic-table-widget/08-RESEARCH.md
@src/widgets/shared/widget-base.ts
@src/widgets/shared/attribute-parser.ts
@src/widgets/geo-stats-widget/csv-exporter.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create table sorting and pagination utilities</name>
  <files>
    src/widgets/geo-table-widget/table-sorter.ts
    src/widgets/geo-table-widget/table-paginator.ts
  </files>
  <action>
Create two utility modules in src/widgets/geo-table-widget/:

**table-sorter.ts:**
- Create a `TableSorter` class with static methods (no instantiation needed)
- Create a single `Intl.Collator` instance (reuse, do NOT create per sort call — research pitfall)
- Implement `sortByString<T>(data: T[], key: keyof T, direction: 'ascending' | 'descending'): T[]` — uses Intl.Collator with `{ numeric: false, sensitivity: 'base' }` for case-insensitive, accent-insensitive locale-aware sort
- Implement `sortByNumber<T>(data: T[], key: keyof T, direction: 'ascending' | 'descending'): T[]` — explicit `Number()` coercion with `|| 0` fallback
- Implement `sort<T>(data: T[], key: keyof T, direction, type: 'string' | 'number'): T[]` — delegates to sortByString or sortByNumber
- CRITICAL: Always sort a COPY (`[...data].sort(...)`) — never mutate original array (research pitfall #5)
- Export `SortState` interface: `{ column: string; direction: 'ascending' | 'descending' }`

**table-paginator.ts:**
- Create a `TablePaginator<T>` class with constructor `(totalRows: number, rowsPerPage: number = 20)`
- Properties: `currentPage` (starts at 1), `rowsPerPage`, `totalRows`
- Getters: `totalPages` (Math.ceil), `startIndex`, `endIndex`
- Methods: `paginate(data: T[]): T[]` (returns slice), `goToPage(page: number)` (boundary-checked), `nextPage()`, `previousPage()`, `updateTotal(totalRows: number)` (resets to page 1 if current page out of bounds)
- Export the class

Both modules: pure TypeScript, no DOM dependencies, no external imports.
  </action>
  <verify>Run `npx tsc --noEmit` to confirm no type errors in the new files.</verify>
  <done>TableSorter sorts string arrays locale-aware and number arrays numerically without mutating input. TablePaginator slices arrays by page with boundary checking.</done>
</task>

<task type="auto">
  <name>Task 2: Create geo-table-widget Custom Element with accessible sortable paginated table</name>
  <files>src/widgets/geo-table-widget/index.ts</files>
  <action>
Create the main widget in src/widgets/geo-table-widget/index.ts:

**Imports:**
- Import `WidgetBase` from `../shared/widget-base.js`
- Import `ThemeManager` from `../shared/theme-manager.js`
- Import `ResponsiveManager` from `../shared/responsive-manager.js`
- Import `parseBoolean, parseNumber, parseEnum` from `../shared/attribute-parser.js`
- Import `TableSorter, SortState` from `./table-sorter.js`
- Import `TablePaginator` from `./table-paginator.js`
- Import `CountryStats, CityStats` from `../geo-stats-widget/csv-exporter.js` (reuse existing types)

**Column configuration:**
- Define `TableColumn` interface: `{ key: string; label: string; sortable: boolean; type: 'string' | 'number' }`
- Define `COUNTRY_COLUMNS` and `CITY_COLUMNS` constants with appropriate column definitions
- Countries: name (string, sortable), distance (number, sortable), runs (number, sortable), cities count (number, sortable)
- Cities: name (string, sortable), country (string, sortable), distance (number, sortable), runs (number, sortable)

**Styles (Constructible Stylesheet):**
- Create a `CSSStyleSheet` via `new CSSStyleSheet()` OUTSIDE the class (shared across instances)
- Use `replaceSync()` to define table styles
- Style the table matching geo-stats-widget aesthetic (same font sizes, padding, colors, dark mode patterns)
- Style sort buttons: `background: none; border: none; cursor: pointer; font: inherit; width: 100%; text-align: left; padding: 0;` with hover state using `var(--widget-accent, #fc4c02)`
- Style sort indicators: `aria-hidden="true"` spans with unicode arrows
- Style pagination controls: flexbox row with prev/next buttons and "X-Y of Z" text centered
- Style pagination buttons matching export-btn style from geo-stats-widget
- Include all dark mode selectors using `:host([data-theme="dark"])` and `@media (prefers-color-scheme: dark)` patterns from existing widgets
- Responsive: `:host([data-size="compact"])` reduces font size and hides less-important columns (cities count for countries, country for cities)

**Widget class (GeoTableWidgetElement extends WidgetBase):**
- `static observedAttributes` extending WidgetBase: add `data-dataset`, `data-rows-per-page`, `data-default-sort`, `data-default-sort-direction`
- Private state: `data` array, `sortState: SortState`, `paginator: TablePaginator`, `columns: TableColumn[]`
- `data-dataset` attribute: `parseEnum(value, ['countries', 'cities'] as const, 'countries')` — determines which dataset and columns to use
- `data-rows-per-page`: `parseNumber(value, 20, 1, 50)` — clamped per research
- `data-default-sort`: initial sort column key (default: 'totalDistanceKm')
- `data-default-sort-direction`: `parseEnum(value, ['ascending', 'descending'] as const, 'descending')`

**connectedCallback override (same pattern as geo-stats-widget):**
- Override connectedCallback completely (like geo-stats-widget does) to add custom fetch logic
- Inject base styles inline (copy pattern from geo-stats-widget)
- Adopt the constructible stylesheet: `this.shadowRoot!.adoptedStyleSheets = [tableStyles]`
- Initialize ThemeManager, ResponsiveManager
- Apply style attributes (width, max-width, padding, bg, text-color, accent)
- Determine dataset from attribute, set columns and default dataUrl accordingly
- Initialize paginator with rows-per-page from attribute
- Initialize sortState from default-sort attributes
- Show loading, call fetchDataAndRender()

**dataUrl getter:**
- Return `/data/geo/countries.json` if dataset is 'countries', `/data/geo/cities.json` if 'cities'

**render(data) method:**
- Store raw data on instance
- Sort data using `TableSorter.sort()` with current sortState and column type
- Paginate sorted data using `paginator.paginate()`
- Clear old table content (keep styles)
- Build table with accessibility:
  - `<table>` with `role="table"` (explicit for Shadow DOM)
  - `<caption>` describing the table and sort instructions (for screen readers)
  - `<thead>` with column headers
  - For sortable columns: `<th>` containing `<button class="sort-button">` with label text + `<span aria-hidden="true" class="sort-indicator">` showing arrow (ascending arrow, descending arrow, or diamond for unsorted)
  - Set `aria-sort` attribute on `<th>` of currently sorted column ONLY (remove from all others first — research pitfall #1)
  - `<tbody>` with data rows
  - Number cells: use `toLocaleString()` for formatted display, right-aligned with `font-variant-numeric: tabular-nums`
- If `paginator.totalPages > 1`: append pagination controls div
- Pagination controls: Previous button (disabled on page 1), "X-Y of Z" span, Next button (disabled on last page)

**handleSort(column) method:**
- Toggle direction if same column, reset to ascending if different column
- Reset paginator to page 1
- Re-render with stored data

**Title support:**
- If `data-show-title` is present (parseBoolean default true), show `<h2>` with `data-title` attribute value or default "Running by Country"/"Running by City" based on dataset

**Register and expose globally:**
- `WidgetBase.register('strava-geo-table', GeoTableWidgetElement)`
- Create backwards-compatible `GeoTableWidget` global init object (same pattern as geo-stats-widget)
- Expose via `(window as any).GeoTableWidget = GeoTableWidget`
  </action>
  <verify>Run `npx tsc --noEmit` to confirm no type errors. Verify the file imports from table-sorter.js and table-paginator.js correctly.</verify>
  <done>GeoTableWidget Custom Element renders accessible sortable paginated table with countries or cities data, shadow DOM isolation, theme support, and responsive sizing.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. All three files exist and export expected types/classes
3. TableSorter sorts without mutating input arrays
4. Widget registers as `strava-geo-table` custom element
5. Widget supports `data-dataset="countries"` and `data-dataset="cities"`
</verification>

<success_criteria>
- Three new TypeScript files compile without errors
- Widget extends WidgetBase and follows established Custom Element patterns
- Sorting uses Intl.Collator for strings, numeric comparison for numbers
- Pagination defaults to 20 rows, clamped 1-50
- Table headers use `<button>` elements with `aria-sort` for accessibility
- Dark mode styles follow existing widget patterns
</success_criteria>

<output>
After completion, create `.planning/phases/08-geographic-table-widget/08-01-SUMMARY.md`
</output>

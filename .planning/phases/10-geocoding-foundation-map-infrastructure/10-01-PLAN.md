---
phase: 10-geocoding-foundation-map-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/geo/geocoder.ts
  - src/geo/cache-manager.ts
  - src/geo/compute-geo-stats.ts
  - data/geo/v1/location-cache.json
  - data/geo/v1/cities.json
  - data/geo/v1/countries.json
autonomous: true

must_haves:
  truths:
    - "User sees accurate city names in geographic stats (e.g., Copenhagen not Frederiksberg, Paris not Gif-sur-Yvette)"
    - "Existing geographic widgets (geo-table-widget, geo-stats-widget) continue working after library change"
    - "Old geocoding data is archived for later comparison (GEO-03 prep)"
  artifacts:
    - path: "src/geo/geocoder.ts"
      provides: "Wrapper for offline-geocoder (GeoNames) instead of offline-geocode-city (UN/LOCODE)"
      contains: "offline-geocoder"
    - path: "src/geo/cache-manager.ts"
      provides: "Versioned cache with geocoder metadata"
      contains: "version"
    - path: "data/geo/v1/location-cache.json"
      provides: "Archived old geocoding results for comparison"
    - path: "data/geo/v1/cities.json"
      provides: "Archived old city statistics"
    - path: "data/geo/v1/countries.json"
      provides: "Archived old country statistics"
  key_links:
    - from: "src/geo/geocoder.ts"
      to: "offline-geocoder"
      via: "import and geo.search(lat, lng)"
      pattern: "geo\\.search"
    - from: "src/geo/cache-manager.ts"
      to: "src/geo/geocoder.ts"
      via: "GeoCache type with version and geocoder fields"
      pattern: "version.*CURRENT_VERSION"
    - from: "src/geo/compute-geo-stats.ts"
      to: "src/geo/geocoder.ts"
      via: "geocodeActivity import"
      pattern: "import.*geocodeActivity"
---

<objective>
Migrate geocoding from offline-geocode-city (UN/LOCODE data) to offline-geocoder (GeoNames cities1000 dataset) to fix the systematic suburb-instead-of-city problem, while preserving old data for comparison and ensuring existing widgets continue working.

Purpose: GEO-01 (accurate city names) and GEO-04 (backward compatibility). The current library returns suburbs (Paris -> Gif-sur-Yvette, Berlin -> Stahnsdorf). GeoNames uses a proper city database with 20,000+ cities worldwide.
Output: Updated geocoder, versioned cache, archived old data in data/geo/v1/, regenerated geographic statistics.
</objective>

<execution_context>
@/Users/pedf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pedf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-geocoding-foundation-map-infrastructure/10-RESEARCH.md
@.planning/phases/05-geocoding-infrastructure/05-01-SUMMARY.md
@src/geo/geocoder.ts
@src/geo/cache-manager.ts
@src/geo/compute-geo-stats.ts
@src/types/strava.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Archive old geo data and swap geocoding library</name>
  <files>
    package.json
    data/geo/v1/location-cache.json
    data/geo/v1/cities.json
    data/geo/v1/countries.json
  </files>
  <action>
    1. Archive existing geo data for GEO-03 comparison:
       - Create `data/geo/v1/` directory
       - Copy `data/geo/location-cache.json` to `data/geo/v1/location-cache.json`
       - Copy `data/geo/cities.json` to `data/geo/v1/cities.json`
       - Copy `data/geo/countries.json` to `data/geo/v1/countries.json`

    2. Swap npm dependencies:
       - `npm uninstall offline-geocode-city`
       - `npm install offline-geocoder@^1.0.2`

    3. Verify: `npm ls offline-geocoder` shows installed, `npm ls offline-geocode-city` shows not found.
  </action>
  <verify>
    - `ls data/geo/v1/` shows location-cache.json, cities.json, countries.json
    - `npm ls offline-geocoder` shows ^1.0.2
    - `npm ls offline-geocode-city` returns error (not installed)
    - `cat data/geo/v1/location-cache.json | head -5` shows old cache data
  </verify>
  <done>Old geo data archived at data/geo/v1/, offline-geocode-city removed, offline-geocoder installed</done>
</task>

<task type="auto">
  <name>Task 2: Update geocoder, cache manager, and compute-geo-stats for new library</name>
  <files>
    src/geo/geocoder.ts
    src/geo/cache-manager.ts
    src/geo/compute-geo-stats.ts
  </files>
  <action>
    1. Update `src/geo/geocoder.ts`:
       - Replace `import { getNearestCity } from 'offline-geocode-city'` with `import geocoder from 'offline-geocoder'`
       - Initialize geocoder: `const geo = geocoder({ citiesFileType: 'cities1000' })` (at module level, outside function)
       - Update `GeoCache` interface to versioned format:
         ```typescript
         export interface GeoCache {
           version: number;
           geocoder: string;
           entries: { [coordKey: string]: GeoLocation; };
         }
         ```
       - Update `geocodeActivity` function:
         - Change cache access from `cache[cacheKey]` to `cache.entries[cacheKey]`
         - Replace `getNearestCity(lat, lng)` with `geo.search(lat, lng)`
         - Map result: `result` is `{ name, countryName, countryCode, ... }` (NOT cityName/countryIso2)
         - Set `cityName: result.name` (not result.cityName)
         - Set `countryIso2: result.countryCode` (not result.countryIso2)
         - Set `countryName: result.countryName`
         - Handle array return: `geo.search()` returns an array, use `results[0]` as the closest match
         - Guard: Check `!results || results.length === 0` for no-match cases (ocean coordinates)
       - Keep `roundCoord` and `coordToCacheKey` functions unchanged (same coordinate rounding strategy)

    2. Update `src/geo/cache-manager.ts`:
       - Add constants: `const CURRENT_VERSION = 2;` and `const CURRENT_GEOCODER = 'geonames-cities1000';`
       - Update `loadCache`:
         - Parse the file, check for `data.version === CURRENT_VERSION && data.geocoder === CURRENT_GEOCODER`
         - If version matches, return data as GeoCache
         - If version mismatch (old format without version field, or wrong version), log warning and return empty cache: `{ version: CURRENT_VERSION, geocoder: CURRENT_GEOCODER, entries: {} }`
         - If file not found (ENOENT), return empty cache
       - Update `saveCache`:
         - Accept `GeoCache` (now has version/geocoder/entries structure)
         - Log entry count from `cache.entries` (not `Object.keys(cache)`)
       - Export `createEmptyCache()` helper function

    3. Update `src/geo/compute-geo-stats.ts`:
       - Import updated `GeoCache` type (now has `.entries`)
       - Update cache usage: cache is now `{ version, geocoder, entries }` not flat object
       - No other changes needed — `geocodeActivity` signature is unchanged (activity, cache) -> GeoLocation | null
       - Update metadata to include geocoder version: add `geocoderVersion: 'geonames-cities1000'` to GeoMetadata interface and output

    4. Build and run:
       - `npm run build` — must compile without errors
       - `npm run compute-geo-stats` — regenerate all geo data with new library
       - Verify output: cities should show actual city names (e.g., Copenhagen area should NOT show Frederiksberg/Roskilde Kommune if coordinate is in Copenhagen proper)

    IMPORTANT: The `offline-geocoder` library default export is a function that returns an object with a `.search(lat, lng)` method. The search method returns an array of results sorted by proximity. Each result has: `name`, `countryName`, `countryCode`, `population`, `latitude`, `longitude`. This differs from `offline-geocode-city` which returned `{ cityName, countryName, countryIso2 }`.
  </action>
  <verify>
    - `npm run build` — TypeScript compiles with zero errors
    - `npm run compute-geo-stats` — runs successfully, prints geocoded count and coverage %
    - `cat data/geo/location-cache.json | head -10` — shows `"version": 2, "geocoder": "geonames-cities1000", "entries": {`
    - `cat data/geo/geo-metadata.json` — shows geocoderVersion field
    - `cat data/geo/cities.json | head -30` — verify city names look like real cities, not suburbs
    - `cat data/geo/countries.json | head -30` — verify country data is populated
    - Diff old vs new top city: compare `data/geo/v1/cities.json` first entry vs `data/geo/cities.json` first entry
  </verify>
  <done>
    Geocoder uses offline-geocoder (GeoNames), cache is versioned (v2), compute-geo-stats regenerates all data with accurate city names, TypeScript compiles, existing geo JSON output schema unchanged (cities.json/countries.json have same field names so widgets work without changes — GEO-04)
  </done>
</task>

</tasks>

<verification>
1. `npm run build` compiles without errors
2. `npm run compute-geo-stats` runs end-to-end and produces data/geo/{cities,countries,geo-metadata,location-cache}.json
3. `data/geo/v1/` contains archived old data (3 files)
4. `data/geo/location-cache.json` has version: 2 and geocoder: "geonames-cities1000"
5. City names in `data/geo/cities.json` are accurate (not suburbs)
6. Output JSON schema is unchanged: cities.json has {cityName, countryName, countryIso2, activityCount, totalDistanceKm}, countries.json has {countryName, countryIso2, activityCount, totalDistanceKm, cities}
7. `npm test` passes (no existing test regressions)
</verification>

<success_criteria>
- offline-geocoder installed, offline-geocode-city removed
- Geocoder wraps offline-geocoder with GeoNames cities1000 dataset
- Location cache is versioned (version: 2, geocoder: geonames-cities1000)
- Old geo data archived at data/geo/v1/ for GEO-03 comparison
- Geographic stats regenerated with improved city names
- Output JSON schema unchanged — existing widgets work without modification (GEO-04)
</success_criteria>

<output>
After completion, create `.planning/phases/10-geocoding-foundation-map-infrastructure/10-01-SUMMARY.md`
</output>

---
phase: 10-geocoding-foundation-map-infrastructure
plan: 03
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - package.json
  - scripts/build-widgets.mjs
  - src/widgets/map-test-widget/index.ts
autonomous: true

must_haves:
  truths:
    - "Leaflet renders correctly in Shadow DOM with all CSS, tiles, and zoom controls working"
    - "Map widgets load with acceptable bundle size (Leaflet externalized to CDN, widget JS < 50KB)"
  artifacts:
    - path: "scripts/build-widgets.mjs"
      provides: "Build configuration for map widgets with Leaflet externalized to CDN"
      contains: "leaflet"
    - path: "src/widgets/map-test-widget/index.ts"
      provides: "Proof-of-concept map widget verifying Leaflet + Shadow DOM integration"
      contains: "L.map"
  key_links:
    - from: "src/widgets/map-test-widget/index.ts"
      to: "leaflet"
      via: "import L from 'leaflet' (externalized to global L)"
      pattern: "import.*leaflet"
    - from: "scripts/build-widgets.mjs"
      to: "vite config"
      via: "rollupOptions.external for leaflet, globals mapping to window.L"
      pattern: "external.*leaflet"
---

<objective>
Set up Leaflet 1.9.4 as the map rendering library with Shadow DOM CSS injection and CDN externalization, verified with a proof-of-concept map widget.

Purpose: Success criteria 5 (Leaflet in Shadow DOM) and 6 (acceptable bundle size). This establishes the map infrastructure pattern that Phase 11-13 widgets will follow.
Output: Leaflet installed, build system configured for CDN externalization, proof-of-concept map widget rendering tiles and controls in Shadow DOM.
</objective>

<execution_context>
@/Users/pedf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pedf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-geocoding-foundation-map-infrastructure/10-RESEARCH.md
@scripts/build-widgets.mjs
@src/widgets/shared/widget-base.ts
@vite.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Leaflet dependencies and configure build system</name>
  <files>
    package.json
    scripts/build-widgets.mjs
  </files>
  <action>
    1. Install Leaflet and supporting packages:
       - `npm install leaflet@^1.9.4`
       - `npm install -D @types/leaflet@^1.9.14`
       - `npm install -D vite-plugin-css-injected-by-js@^3.5.1`

    2. Update `scripts/build-widgets.mjs` to support map widgets with Leaflet externalization:
       - Import `cssInjectedByJsPlugin` from `vite-plugin-css-injected-by-js` at the top
       - Add the map-test-widget to the widgets array:
         ```javascript
         {
           name: 'map-test',
           entry: resolve(__dirname, '../src/widgets/map-test-widget/index.ts'),
           globalName: 'MapTestWidget',
           isMapWidget: true  // Flag for Leaflet externalization
         }
         ```
       - Update `buildWidget` function to handle map widgets differently:
         - If `widget.isMapWidget` is true:
           - Add `cssInjectedByJsPlugin()` to plugins array
           - Set `rollupOptions.external` to `['leaflet']`
           - Set `rollupOptions.output.globals` to `{ 'leaflet': 'L' }`
         - If `widget.isMapWidget` is false (existing widgets):
           - Keep current config unchanged (no plugins, no externals)
       - This ensures existing Chart.js widgets are NOT affected by the Leaflet changes

    3. Verify build system compiles:
       - The map widget won't exist yet, so comment out the map-test entry temporarily OR create a minimal placeholder.
       - Actually, proceed to Task 2 first before running the build.
  </action>
  <verify>
    - `npm ls leaflet` shows ^1.9.4
    - `npm ls @types/leaflet` shows ^1.9.14
    - `npm ls vite-plugin-css-injected-by-js` shows ^3.5.1
    - `cat scripts/build-widgets.mjs` shows map widget entry with isMapWidget flag
    - `cat scripts/build-widgets.mjs` shows conditional Leaflet externalization logic
  </verify>
  <done>
    Leaflet and supporting packages installed, build-widgets.mjs updated with map widget support and Leaflet CDN externalization pattern.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create proof-of-concept map widget with Shadow DOM</name>
  <files>
    src/widgets/map-test-widget/index.ts
  </files>
  <action>
    1. Create `src/widgets/map-test-widget/index.ts` — a minimal map widget that proves Leaflet works in Shadow DOM:
       - Import `L` from `leaflet` (will be resolved from CDN global at runtime)
       - Import `'leaflet/dist/leaflet.css'` (will be injected by vite-plugin-css-injected-by-js)
       - Import `WidgetBase` from shared widget-base
       - Import marker icon images for Vite bundler fix:
         ```typescript
         import markerIcon from 'leaflet/dist/images/marker-icon.png';
         import markerIcon2x from 'leaflet/dist/images/marker-icon-2x.png';
         import markerShadow from 'leaflet/dist/images/marker-shadow.png';
         ```
       - Fix default marker icons (required for Vite):
         ```typescript
         delete (L.Icon.Default.prototype as any)._getIconUrl;
         L.Icon.Default.mergeOptions({
           iconUrl: markerIcon,
           iconRetinaUrl: markerIcon2x,
           shadowUrl: markerShadow,
         });
         ```

       - Create `MapTestWidgetElement extends WidgetBase`:
         - Private field: `map: L.Map | null = null`
         - Override `dataUrl` getter to return empty string (this widget doesn't fetch data)
         - Override `connectedCallback`:
           - Call `super.connectedCallback()`
           - Create map container div (100% width, 400px height)
           - Append to shadowRoot
           - Initialize Leaflet map on the container: `L.map(container).setView([55.6761, 12.5683], 13)` (Copenhagen default)
           - Add OpenStreetMap tile layer with proper attribution:
             ```typescript
             L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
               attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
               maxZoom: 19
             }).addTo(this.map);
             ```
           - Add a test marker at the center point
         - Override `disconnectedCallback`:
           - Call `super.disconnectedCallback()`
           - If map exists, call `this.map.remove()` and set to null
         - Override `render(data: unknown)`: no-op (map widget manages its own rendering)
         - Override `fetchDataAndRender`: just clear loading message (no data to fetch)

       - Register: `WidgetBase.register('map-test-widget', MapTestWidgetElement)`

    2. Build all widgets:
       - `npm run build-widgets`
       - Verify the map-test.iife.js is created in dist/widgets/
       - Check bundle size: `ls -la dist/widgets/map-test.iife.js` — should be < 50KB (Leaflet externalized)
       - Compare with a Chart.js widget: `ls -la dist/widgets/stats-card.iife.js` — map widget should be significantly smaller

    3. Create a quick manual test (optional but recommended):
       - The existing index.html test page could be updated, but that's Phase 11+ territory
       - Instead, verify by checking the build output:
         - `grep -c "L.map" dist/widgets/map-test.iife.js` should show references to L.map
         - `grep -c "leaflet" dist/widgets/map-test.iife.js` should be minimal (externalized)
         - The bundle should NOT contain the full Leaflet source code

    NOTE on CSS injection in Shadow DOM: The `vite-plugin-css-injected-by-js` plugin injects CSS into the document head by default. For Shadow DOM widgets, the CSS needs to be in the shadow root. The current WidgetBase pattern uses inline styles. For map widgets, the CSS injection approach may need adjustment:
    - Option A: The plugin has a `styleId` option and can be configured to inject into a specific container
    - Option B: The Leaflet CSS can be manually extracted and added as a `<style>` element in the shadow root
    - Option C: Use the plugin's `topExecutionPriority` option to ensure CSS is available before map init

    Start with the default plugin behavior. If CSS doesn't render in Shadow DOM during Phase 11 testing, switch to manually injecting the CSS string. For Phase 10, the proof-of-concept validates that the build pipeline works and the widget compiles.
  </action>
  <verify>
    - `npm run build-widgets` completes without errors for ALL widgets (existing + map-test)
    - `ls dist/widgets/map-test.iife.js` exists
    - `wc -c dist/widgets/map-test.iife.js` shows < 50KB (Leaflet not bundled)
    - `ls dist/widgets/stats-card.iife.js` still exists (existing widgets not broken)
    - `ls dist/widgets/geo-table-widget.iife.js` still exists (geo widgets not broken)
    - All 6 widget bundles present in dist/widgets/ (5 existing + map-test)
  </verify>
  <done>
    Proof-of-concept map widget created and building successfully. Leaflet externalized to CDN (bundle < 50KB). All existing widgets continue building without changes. Shadow DOM + Leaflet integration pattern established for Phase 11-13.
  </done>
</task>

</tasks>

<verification>
1. `npm run build-widgets` builds all 6 widgets (5 existing + map-test) without errors
2. Map widget bundle size < 50KB (Leaflet externalized, not bundled)
3. Existing widget bundles unchanged in size and behavior
4. Build system conditionally applies Leaflet externalization only to map widgets
5. `npm test` passes (no regressions from new dependencies)
</verification>

<success_criteria>
- Leaflet 1.9.4 installed with TypeScript types
- Build system configured with Leaflet CDN externalization for map widgets only
- vite-plugin-css-injected-by-js handles CSS bundling for map widgets
- Proof-of-concept map-test-widget compiles and builds as < 50KB IIFE bundle
- Existing Chart.js widgets build unchanged
- Pattern established for Phase 11-13 map widget development
</success_criteria>

<output>
After completion, create `.planning/phases/10-geocoding-foundation-map-infrastructure/10-03-SUMMARY.md`
</output>

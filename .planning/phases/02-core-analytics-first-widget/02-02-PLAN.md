---
phase: 02-core-analytics-first-widget
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - package.json
  - vite.config.ts
  - tsconfig.widget.json
  - src/widget/index.ts
  - src/widget/chart-config.ts
  - src/widget/styles.css
  - dist/widget/weekly-bar-chart.iife.js
  - public/test-embed.html
autonomous: false

must_haves:
  truths:
    - "User can see weekly km totals displayed as a bar chart"
    - "Widget renders as self-contained JavaScript bundle embeddable via script tag"
    - "Widget loads pre-generated static JSON data without runtime API calls"
    - "Widget displays correctly when embedded in a test HTML page"
    - "Widget is style-isolated via Shadow DOM (does not leak styles to host page)"
  artifacts:
    - path: "src/widget/index.ts"
      provides: "Widget entry point with Shadow DOM setup and global init function"
      exports: ["WeeklyBarChart (global IIFE)"]
    - path: "src/widget/chart-config.ts"
      provides: "Chart.js bar chart configuration with tree-shaken imports"
      exports: ["createWeeklyBarChart"]
    - path: "vite.config.ts"
      provides: "Vite library mode configuration for IIFE bundling"
      contains: "formats.*iife"
    - path: "dist/widget/weekly-bar-chart.iife.js"
      provides: "Built widget bundle (self-contained IIFE)"
    - path: "public/test-embed.html"
      provides: "Test page for widget embedding verification"
      contains: "script.*weekly-bar-chart"
  key_links:
    - from: "src/widget/index.ts"
      to: "src/widget/chart-config.ts"
      via: "import createWeeklyBarChart"
      pattern: "import.*chart-config"
    - from: "src/widget/index.ts"
      to: "data/stats/weekly-distance.json"
      via: "fetch(dataUrl) at runtime"
      pattern: "fetch.*dataUrl|fetch.*json"
    - from: "public/test-embed.html"
      to: "dist/widget/weekly-bar-chart.iife.js"
      via: "script src tag"
      pattern: "script.*weekly-bar-chart"
    - from: "vite.config.ts"
      to: "src/widget/index.ts"
      via: "build.lib.entry"
      pattern: "entry.*widget/index"
---

<objective>
Build the embeddable weekly bar chart widget using Chart.js and Vite, producing a self-contained IIFE JavaScript bundle that renders weekly running distance as a bar chart inside Shadow DOM, loading data from pre-generated static JSON.

Purpose: This is the "visualize" layer of the pipeline. The widget is what gets embedded on the user's personal website to display their running stats.

Output: Built widget bundle (IIFE), Vite config, test embedding page, verified visual rendering.
</objective>

<execution_context>
@/Users/pedf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pedf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-analytics-first-widget/02-RESEARCH.md
@.planning/phases/02-core-analytics-first-widget/02-01-SUMMARY.md
@src/types/analytics.types.ts
@data/stats/weekly-distance.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Widget source, Vite config, and build</name>
  <files>package.json, vite.config.ts, tsconfig.widget.json, src/widget/index.ts, src/widget/chart-config.ts, src/widget/styles.css</files>
  <action>
**Step 1: Install dependencies**

```bash
npm install chart.js
npm install --save-dev vite
```

**Step 2: Create tsconfig.widget.json** for widget-specific TypeScript config. The existing tsconfig.json uses Node16 module resolution which is for the Node.js analytics code. The widget needs browser-compatible settings:

```json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "ESNext",
    "moduleResolution": "bundler",
    "outDir": "dist/widget",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"]
  },
  "include": ["src/widget/**/*", "src/types/**/*"]
}
```

**Step 3: Create src/widget/chart-config.ts** with tree-shaken Chart.js imports:

Import ONLY the needed components from chart.js (NOT from 'chart.js/auto'):
- Chart, BarController, BarElement, CategoryScale, LinearScale, Title, Tooltip

Register only those components via Chart.register().

Export `createWeeklyBarChart(canvas: HTMLCanvasElement, data: WeeklyStats[]): Chart` function that:
- Creates a bar chart with labels from data (formatted as "Week of M/D" using the weekStartISO dates)
- Single dataset: "Weekly Distance (km)" with data mapped from totalKm values
- Bar color: rgba(252, 76, 2, 0.8) with border rgba(252, 76, 2, 1) (Strava orange)
- Options: responsive: true, maintainAspectRatio: true, aspectRatio: 2
- Y-axis: beginAtZero: true, title: "Distance (km)"
- X-axis title: none (dates are self-explanatory)
- Plugin title: "Weekly Running Distance"
- Tooltip: show km with 1 decimal place
- Limit visible bars to last 12 weeks by slicing data (pass full dataset but show recent by default). If data has more than 12 entries, only take the last 12.

Import WeeklyStats type from src/types/analytics.types.ts (use relative import path).

**Step 4: Create src/widget/styles.css** with widget-scoped styles:

```css
:host {
  display: block;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  color: #333;
}
.chart-container {
  position: relative;
  width: 100%;
  max-width: 800px;
  margin: 0 auto;
}
.chart-container canvas {
  min-width: 0; /* Prevent flexbox overflow (research pitfall #5) */
}
.widget-error {
  padding: 16px;
  text-align: center;
  color: #999;
  font-size: 14px;
}
.widget-loading {
  padding: 16px;
  text-align: center;
  color: #666;
  font-size: 14px;
}
```

**Step 5: Create src/widget/index.ts** as the widget entry point:

Create a class `WeeklyBarChartWidget` that:
1. Takes containerId (string) and dataUrl (string) in constructor
2. Finds the container element by ID; logs error and returns if not found
3. Attaches a Shadow DOM (mode: 'open') to the container
4. Injects the styles from styles.css inline into a `<style>` tag inside Shadow DOM
5. Creates the chart container div with position: relative and a canvas element
6. Shows a "Loading..." message initially
7. Fetches data from dataUrl using fetch()
8. On success: creates chart using createWeeklyBarChart, passing the canvas from shadowRoot
9. On error: shows "Chart unavailable" message in shadow DOM; logs error to console (fail silently for embeddable widgets)

Expose a global initialization function:
```typescript
// Attach to window for IIFE usage
const WeeklyBarChart = {
  init(containerId: string, dataUrl: string) {
    return new WeeklyBarChartWidget(containerId, dataUrl);
  }
};

// Make available globally
(window as any).WeeklyBarChart = WeeklyBarChart;
```

IMPORTANT: Inline the CSS as a string constant in the TypeScript file rather than importing the .css file. This avoids CSS extraction issues with Vite IIFE builds. Read the styles.css content and embed it as a template literal. Keep the styles.css file for reference but the actual styles used are the inlined string.

**Step 6: Create vite.config.ts:**

```typescript
import { defineConfig } from 'vite';
import { resolve } from 'path';

export default defineConfig({
  build: {
    lib: {
      entry: resolve(__dirname, 'src/widget/index.ts'),
      name: 'WeeklyBarChart',
      fileName: 'weekly-bar-chart',
      formats: ['iife']
    },
    outDir: 'dist/widget',
    emptyDir: true,
    rollupOptions: {
      external: [],
      output: {
        inlineDynamicImports: true,
        globals: {}
      }
    },
    target: 'es2020',
    minify: 'terser',
    terserOptions: {
      compress: {
        drop_console: false // Keep console.error for widget debugging
      }
    }
  }
});
```

**Step 7: Build the widget:**

```bash
npx vite build
```

Verify the output file exists at dist/widget/weekly-bar-chart.iife.js and log its file size. Target: under 100KB gzipped (likely ~20-40KB based on tree-shaken Chart.js).
  </action>
  <verify>
1. `npx vite build` completes without errors
2. `ls -la dist/widget/weekly-bar-chart.iife.js` shows the file exists with reasonable size
3. `npx tsc -p tsconfig.widget.json --noEmit` compiles widget code without errors
4. The built file contains "WeeklyBarChart" as a global (grep for it in the output)
  </verify>
  <done>Widget source files created, Vite configured for IIFE library mode, and bundle built to dist/widget/weekly-bar-chart.iife.js. Chart.js tree-shaken to bar chart components only.</done>
</task>

<task type="auto">
  <name>Task 2: Test embedding page and local verification</name>
  <files>public/test-embed.html</files>
  <action>
Create public/test-embed.html that demonstrates the widget working in a realistic embedding scenario:

```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Strava Widget - Embedding Test</title>
  <style>
    /* Host page styles - deliberately different to test isolation */
    body {
      font-family: Georgia, serif;
      background: #f5f5f5;
      color: #222;
      max-width: 900px;
      margin: 40px auto;
      padding: 0 20px;
    }
    h1 { color: #333; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
    p { line-height: 1.6; }
    .embed-section {
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 24px;
      margin: 24px 0;
    }
  </style>
</head>
<body>
  <h1>Widget Embedding Test</h1>
  <p>This page simulates embedding the Strava weekly bar chart widget on a personal website.
     The widget should render inside Shadow DOM, isolated from these host page styles.</p>

  <div class="embed-section">
    <h2>Weekly Running Distance</h2>
    <div id="strava-weekly-chart"></div>
  </div>

  <p>If the chart appears above with bar data, the widget is working correctly.
     The widget styles should not affect this paragraph (it should remain Georgia serif).</p>

  <!-- Widget embedding: exactly what a user would copy-paste -->
  <script src="../dist/widget/weekly-bar-chart.iife.js"></script>
  <script>
    // Initialize with local data file path
    WeeklyBarChart.init('strava-weekly-chart', '../data/stats/weekly-distance.json');
  </script>
</body>
</html>
```

After creating the file, start a local server for the checkpoint verification:

```bash
cd /Users/pedf/workspace/housing-price-denmark && npx -y serve . -p 4173
```

Do NOT try to open a browser - the checkpoint task handles human verification.
  </action>
  <verify>
1. `cat public/test-embed.html` shows valid HTML with script tag referencing the built widget
2. The HTML references ../dist/widget/weekly-bar-chart.iife.js (correct relative path)
3. The HTML references ../data/stats/weekly-distance.json (correct relative path)
  </verify>
  <done>Test embedding page created at public/test-embed.html with host page styles demonstrating Shadow DOM isolation. Ready for visual verification.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Visual verification of embedded widget</name>
  <files>public/test-embed.html</files>
  <action>
Human verifies the widget renders correctly in the test embedding page. This is a visual checkpoint - no code changes needed.

What was built: Complete embeddable widget pipeline - Chart.js bar chart rendered inside Shadow DOM, bundled as IIFE via Vite, loading weekly distance data from pre-generated static JSON. Test page demonstrates embedding with style isolation.
  </action>
  <verify>
1. Start a local server from the project root:
   `cd /Users/pedf/workspace/housing-price-denmark && npx -y serve . -p 4173`
2. Open http://localhost:4173/public/test-embed.html in your browser
3. Verify:
   - A bar chart appears showing "Weekly Running Distance"
   - Bars show weekly km totals (most recent 12 weeks)
   - The chart uses orange bars (Strava brand color)
   - Y-axis shows "Distance (km)"
   - Hovering over bars shows tooltips with km values
   - The host page text remains Georgia serif (style isolation working)
   - The chart is responsive (resize browser window to test)
4. Check browser console for any errors (there should be none)
  </verify>
  <done>User confirms: chart renders correctly with bar data, style isolation works, no console errors. Type "approved" or describe issues.</done>
</task>

</tasks>

<verification>
1. Widget builds: `npx vite build` produces dist/widget/weekly-bar-chart.iife.js
2. Bundle size: Under 100KB (gzipped), ideally 20-50KB with tree-shaken Chart.js
3. Self-contained: Single .js file with no external dependencies at runtime
4. Style isolation: Widget styles do not leak to host page (Shadow DOM)
5. Data loading: Widget fetches from static JSON URL, no runtime API calls
6. Embedding: Standard script tag + init call pattern works in test page
7. Chart renders: Bar chart visible with correct data, tooltips, responsive sizing
</verification>

<success_criteria>
- Widget bundle exists at dist/widget/weekly-bar-chart.iife.js
- Widget renders weekly km bar chart when embedded via script tag
- Widget loads data from static JSON (no runtime API calls to Strava)
- Widget uses Shadow DOM for style isolation
- Test embedding page demonstrates correct rendering
- User visually confirms chart displays correctly (checkpoint)
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-analytics-first-widget/02-02-SUMMARY.md`
</output>

---
phase: 02-core-analytics-first-widget
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/analytics.types.ts
  - src/analytics/date-utils.ts
  - src/analytics/compute-stats.ts
  - src/index.ts
  - data/stats/weekly-distance.json
  - data/stats/all-time-totals.json
  - data/stats/metadata.json
autonomous: true

must_haves:
  truths:
    - "System computes weekly distance totals from activity JSON files"
    - "System computes all-time totals (total km, total runs, total hours, total elevation)"
    - "System computes average pace per period using total_time/total_distance (not averaging individual paces)"
    - "System computes elevation gain and run count per period"
    - "Statistics are written as pre-generated static JSON files to data/stats/"
    - "User can trigger stat computation via CLI command"
  artifacts:
    - path: "src/types/analytics.types.ts"
      provides: "TypeScript interfaces for weekly stats, all-time totals, period stats"
      exports: ["WeeklyStats", "AllTimeTotals", "PeriodStats"]
    - path: "src/analytics/date-utils.ts"
      provides: "UTC week boundary calculations (Monday-start)"
      exports: ["getWeekStart", "getMonthStart", "getYearStart"]
    - path: "src/analytics/compute-stats.ts"
      provides: "Statistics computation from activity files"
      exports: ["computeAllStats"]
    - path: "data/stats/weekly-distance.json"
      provides: "Pre-generated weekly distance data"
    - path: "data/stats/all-time-totals.json"
      provides: "Pre-generated all-time totals"
  key_links:
    - from: "src/analytics/compute-stats.ts"
      to: "data/activities/*.json"
      via: "FileStore.listFiles + readJson"
      pattern: "readdir.*activities"
    - from: "src/analytics/compute-stats.ts"
      to: "data/stats/*.json"
      via: "writeFile/writeJson"
      pattern: "write.*(stats|weekly|totals)"
    - from: "src/index.ts"
      to: "src/analytics/compute-stats.ts"
      via: "CLI compute-stats command"
      pattern: "computeAllStats|compute-stats"
---

<objective>
Build the statistics computation pipeline that reads 1,808 activity JSON files from data/activities/, computes weekly/monthly/yearly aggregations and all-time totals, and writes pre-generated static JSON files to data/stats/.

Purpose: Transform raw Strava activity data into the structured statistical datasets that the embeddable widget (Plan 02) will visualize. This is the "compute" layer of the fetch -> compute -> visualize pipeline.

Output: TypeScript analytics modules, generated JSON stat files, and a CLI command to trigger computation.
</objective>

<execution_context>
@/Users/pedf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pedf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-analytics-first-widget/02-RESEARCH.md
@src/types/strava.types.ts
@src/storage/file-store.ts
@src/config/strava.config.ts
@src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Analytics types and date utilities</name>
  <files>src/types/analytics.types.ts, src/analytics/date-utils.ts</files>
  <action>
Create analytics type definitions in src/types/analytics.types.ts:

```typescript
// Weekly aggregation for bar chart data
interface WeeklyStats {
  weekStartISO: string;   // ISO 8601 Monday UTC (e.g., "2024-01-01T00:00:00.000Z")
  totalKm: number;        // Total distance in km
  runCount: number;        // Number of runs
  avgPaceMinPerKm: number; // Average pace in min/km (total_time/total_distance)
  elevationGain: number;   // Total elevation gain in meters
  totalMovingTimeMin: number; // Total moving time in minutes
}

// All-time cumulative totals
interface AllTimeTotals {
  totalKm: number;
  totalRuns: number;
  totalHours: number;      // Total moving time in hours
  totalElevation: number;  // Total elevation gain in meters
  avgPaceMinPerKm: number; // Overall average pace
  firstActivityDate: string; // ISO date of earliest activity
  lastActivityDate: string;  // ISO date of latest activity
  generatedAt: string;       // ISO timestamp of computation
}

// Per-period stats (reusable for monthly/yearly)
interface PeriodStats {
  periodStart: string;     // ISO date
  periodLabel: string;     // Human-readable label (e.g., "Jan 2024", "2024")
  totalKm: number;
  runCount: number;
  avgPaceMinPerKm: number;
  elevationGain: number;
  totalMovingTimeMin: number;
}

// Metadata about the generated stats
interface StatsMetadata {
  generatedAt: string;
  activityCount: number;
  dateRange: { from: string; to: string };
  files: string[];
}
```

Export all interfaces.

Create date utility functions in src/analytics/date-utils.ts:

1. `getWeekStart(date: Date): Date` - Returns Monday 00:00:00 UTC of the given date's week. Use getUTCDay() for timezone safety (NOT getDay()). Monday offset: dayOfWeek === 0 ? -6 : 1 - dayOfWeek.

2. `getMonthStart(date: Date): Date` - Returns first day of month at 00:00:00 UTC.

3. `getYearStart(date: Date): Date` - Returns January 1st at 00:00:00 UTC.

4. `formatWeekLabel(isoDate: string): string` - Returns human-readable "Week of M/D" format.

5. `formatMonthLabel(isoDate: string): string` - Returns "Jan 2024" format.

All date functions MUST use UTC methods exclusively (getUTCFullYear, getUTCMonth, getUTCDate, getUTCDay, setUTCDate, setUTCHours). Never use local timezone methods.
  </action>
  <verify>npx tsc --noEmit passes with zero errors. Both files exist and export the expected types/functions.</verify>
  <done>Analytics type interfaces and UTC-safe date utility functions compiled and exported correctly.</done>
</task>

<task type="auto">
  <name>Task 2: Statistics computation engine and CLI integration</name>
  <files>src/analytics/compute-stats.ts, src/index.ts, data/stats/weekly-distance.json, data/stats/all-time-totals.json, data/stats/metadata.json</files>
  <action>
Create src/analytics/compute-stats.ts with a `computeAllStats` function that:

1. **Load activities:** Read all JSON files from data/activities/ using fs/promises readdir + readFile. Parse each as StravaActivity (import from src/types/strava.types.ts). Filter to only include type === "Run" activities (defensive, even though Phase 1 already filters).

2. **Sort activities** by start_date ascending for consistent processing.

3. **Compute weekly stats:** Group activities by UTC week start (using getWeekStart from date-utils). For each week, calculate:
   - totalKm: sum of (distance / 1000) across activities
   - runCount: count of activities
   - avgPaceMinPerKm: (sum of moving_time in minutes) / (sum of distance in km). Use total_time/total_distance, NOT average of individual paces (per research pitfall #6).
   - elevationGain: sum of total_elevation_gain
   - totalMovingTimeMin: sum of (moving_time / 60)
   Sort result array by weekStartISO ascending.

4. **Compute all-time totals:** Single pass accumulating totalKm, totalRuns, totalHours (moving_time sum / 3600), totalElevation, avgPaceMinPerKm (total minutes / total km), firstActivityDate, lastActivityDate.

5. **Compute monthly and yearly stats:** Same aggregation logic as weekly but grouped by month start and year start. Store as PeriodStats arrays.

6. **Write output files:** Create data/stats/ directory if it doesn't exist (mkdir recursive). Write:
   - data/stats/weekly-distance.json (WeeklyStats[])
   - data/stats/all-time-totals.json (AllTimeTotals)
   - data/stats/monthly-stats.json (PeriodStats[])
   - data/stats/yearly-stats.json (PeriodStats[])
   - data/stats/metadata.json (StatsMetadata with generatedAt, activityCount, dateRange, list of generated files)

   Use JSON.stringify with 2-space indent for readability. Log count of weeks/activities processed.

7. **Export** the `computeAllStats` function accepting an optional activitiesDir and statsDir parameter (defaulting to config paths from strava.config.ts or sensible defaults like 'data/activities' and 'data/stats').

Then modify src/index.ts to add a `compute-stats` command:
- Add a `computeStatsCommand()` function that calls `computeAllStats()` and logs results.
- Add 'compute-stats' case to the switch statement in main().
- Add to the help text: "compute-stats - Compute statistics from synced activities"
- Add npm script in package.json: `"compute-stats": "node dist/index.js compute-stats"`

After writing the code, run:
1. `npx tsc` to compile
2. `node dist/index.js compute-stats` to generate the stats files from the 1,808 real activities

Log the output to verify it processed all activities and created the JSON files.
  </action>
  <verify>
1. `npx tsc --noEmit` passes with zero errors
2. `node dist/index.js compute-stats` runs successfully and outputs activity/week counts
3. `cat data/stats/metadata.json` shows activityCount matching ~1808 activities
4. `cat data/stats/weekly-distance.json | head -20` shows valid weekly data with reasonable km values
5. `cat data/stats/all-time-totals.json` shows cumulative totals
6. `ls data/stats/` shows all 5 JSON files
  </verify>
  <done>Statistics computation generates weekly-distance.json, all-time-totals.json, monthly-stats.json, yearly-stats.json, and metadata.json from 1,808 activity files. CLI command `compute-stats` triggers generation successfully.</done>
</task>

</tasks>

<verification>
1. All TypeScript compiles: `npx tsc --noEmit` passes
2. Stats pipeline runs: `node dist/index.js compute-stats` completes without error
3. JSON files exist: `ls data/stats/` shows weekly-distance.json, all-time-totals.json, monthly-stats.json, yearly-stats.json, metadata.json
4. Data integrity: weekly-distance.json contains entries with reasonable totalKm values (not 0, not millions), metadata shows ~1808 activities processed
5. All-time totals are consistent: totalRuns matches activity count, totalKm > 0
6. Average pace is reasonable: something in the 4-8 min/km range for running
</verification>

<success_criteria>
- Statistics computed from 1,808 activity files without errors
- 5 JSON files generated in data/stats/ with correct data shapes
- CLI command `compute-stats` works end-to-end
- Average pace calculated correctly using total_time/total_distance method
- All dates use UTC (no timezone-dependent calculations)
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-analytics-first-widget/02-01-SUMMARY.md`
</output>

---
phase: 03-advanced-analytics-widget-library
plan: 03
type: execute
wave: 2
depends_on: ["03-01", "03-02"]
files_modified:
  - src/types/widget-config.types.ts
  - src/widgets/shared/widget-base.ts
  - src/widgets/stats-card/index.ts
  - src/widgets/comparison-chart/index.ts
  - src/widgets/comparison-chart/chart-config.ts
  - vite.config.ts
  - tsconfig.widget.json
autonomous: true

must_haves:
  truths:
    - "Stats card widget displays year-over-year totals (km, runs, hours) with current streak"
    - "Comparison chart widget shows grouped bar chart with year-over-year monthly distance and a seasonal trends line chart"
    - "Both widgets render inside Shadow DOM with complete style isolation"
    - "Widgets accept configuration for colors, sizes, and options via init() call"
    - "Each widget can be embedded independently via a single script tag without conflicts"
  artifacts:
    - path: "src/types/widget-config.types.ts"
      provides: "Shared widget configuration interface"
      exports: ["WidgetConfig"]
    - path: "src/widgets/shared/widget-base.ts"
      provides: "Base class for all widgets with Shadow DOM setup"
      exports: ["WidgetBase"]
    - path: "src/widgets/stats-card/index.ts"
      provides: "Stats card widget"
      contains: "StatsCard"
    - path: "src/widgets/comparison-chart/index.ts"
      provides: "Year-over-year comparison and seasonal trends widget"
      contains: "ComparisonChart"
    - path: "vite.config.ts"
      provides: "Multi-entry Vite configuration for widget library"
      contains: "stats-card.*comparison-chart"
  key_links:
    - from: "src/widgets/stats-card/index.ts"
      to: "data/stats/year-over-year.json"
      via: "fetch from dataUrl config"
      pattern: "fetch.*dataUrl"
    - from: "src/widgets/comparison-chart/chart-config.ts"
      to: "chart.js"
      via: "tree-shaken imports for bar and line charts"
      pattern: "BarController|LineController"
    - from: "vite.config.ts"
      to: "src/widgets/"
      via: "multi-entry lib configuration"
      pattern: "entry.*stats-card|comparison-chart"
---

<objective>
Build the widget infrastructure (shared base class, config types) and first two widgets: a stats summary card and a year-over-year comparison chart with seasonal trends.

Purpose: Establishes the multi-widget architecture and delivers the data-heavy visualization widgets. Stats card provides at-a-glance numbers. Comparison chart enables year-over-year pattern recognition.

Output: WidgetBase class, WidgetConfig types, StatsCard and ComparisonChart widgets, Vite multi-entry config producing separate IIFE bundles.
</objective>

<execution_context>
@/Users/pedf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pedf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-advanced-analytics-widget-library/03-RESEARCH.md
@.planning/phases/03-advanced-analytics-widget-library/03-01-SUMMARY.md
@.planning/phases/03-advanced-analytics-widget-library/03-02-SUMMARY.md

@src/widget/index.ts
@src/widget/chart-config.ts
@vite.config.ts
@tsconfig.widget.json
@src/types/analytics.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Widget config types, shared base class, and stats card widget</name>
  <files>src/types/widget-config.types.ts, src/widgets/shared/widget-base.ts, src/widgets/stats-card/index.ts</files>
  <action>
    Create src/types/widget-config.types.ts with a standardized WidgetConfig interface:
    ```typescript
    export interface WidgetConfig {
      dataUrl: string;                    // URL to JSON data file
      colors?: {
        background?: string;              // Default '#ffffff'
        text?: string;                    // Default '#333333'
        accent?: string;                  // Default '#fc4c02' (Strava orange)
        chartColors?: string[];           // For multi-dataset charts
      };
      size?: {
        width?: string;                   // CSS unit, default '100%'
        maxWidth?: string;                // CSS unit, default '800px'
        padding?: string;                 // CSS unit, default '20px'
      };
      dateRange?: {
        start?: string;                   // ISO date string filter
        end?: string;
      };
      options?: {
        showLegend?: boolean;             // Default true
        showTitle?: boolean;              // Default true
        customTitle?: string;
      };
    }
    ```

    Create src/widgets/shared/widget-base.ts as an abstract base class that:
    - Takes containerId and WidgetConfig in constructor
    - Finds container element, attaches Shadow DOM (mode: 'open')
    - Injects base styles (font-family, box-sizing, color scheme from config)
    - Applies CSS custom properties from config.colors and config.size
    - Shows loading state, handles fetch errors with "Widget unavailable" message
    - Provides protected methods: createShadowRoot(), showLoading(), showError(), fetchData<T>(url)
    - Abstract method render(data: unknown) that subclasses implement
    - Follow Phase 2 pattern: fail silently for embeddings (console.error, show error in widget)

    Create src/widgets/stats-card/index.ts:
    - Extends WidgetBase
    - Fetches TWO JSON files: year-over-year.json AND all-time-totals.json (accept secondary dataUrl or derive from base path)
    - Actually, simpler: accept a single dataUrl pointing to all-time-totals.json, and an optional second URL for year-over-year data via config.options
    - Renders a card layout with:
      * Total distance (km), total runs, total hours (from all-time-totals.json)
      * Year-over-year comparison: current year vs previous year for total km, with delta percentage
      * Average pace
      * Streak info placeholder (shows "--" until streak data integrated in Plan 04)
    - All DOM construction via createElement (no innerHTML for data values)
    - Inline CSS in template literal (matching Phase 2 pattern)
    - Card styling: rounded corners, subtle shadow, grid layout for stat items
    - CSS custom properties for theming: --card-bg, --card-text, --card-accent from config
    - Expose global: `(window as any).StatsCard = { init(id, config) { ... } }`
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify all types compile without errors.
    Check that src/types/widget-config.types.ts, src/widgets/shared/widget-base.ts, and src/widgets/stats-card/index.ts exist and have correct exports.
  </verify>
  <done>
    WidgetConfig interface defined. WidgetBase provides Shadow DOM setup, loading/error states, and data fetching. StatsCard widget renders all-time totals with year-over-year comparison in a styled card.
  </done>
</task>

<task type="auto">
  <name>Task 2: Comparison chart widget and Vite multi-entry build</name>
  <files>src/widgets/comparison-chart/index.ts, src/widgets/comparison-chart/chart-config.ts, vite.config.ts, tsconfig.widget.json</files>
  <action>
    Create src/widgets/comparison-chart/chart-config.ts:
    - Tree-shaken Chart.js imports for BOTH bar and line charts:
      BarController, BarElement, LineController, LineElement, PointElement, CategoryScale, LinearScale, Title, Tooltip, Legend, Filler
    - Register all needed components
    - Export createYearOverYearChart(canvas, YearOverYearMonth[], config): creates grouped bar chart showing monthly distance per year, up to 3 most recent years, with year-labeled datasets in distinct colors (blue, red, green)
    - Export createSeasonalTrendsChart(canvas, SeasonalTrendMonth[], config): creates multi-year line chart with smooth curves (tension: 0.3), month labels on x-axis, distance on y-axis, up to 3 years
    - Both charts: responsive, maintainAspectRatio with aspectRatio 2, beginAtZero on y-axis, respect config.colors.chartColors if provided

    Create src/widgets/comparison-chart/index.ts:
    - Extends WidgetBase
    - Fetches year-over-year.json (primary dataUrl) and seasonal-trends.json (secondary URL via config)
    - Renders two charts vertically stacked: year-over-year grouped bars on top, seasonal trends line chart below
    - Each chart in its own container div with a canvas element
    - Expose global: `(window as any).ComparisonChart = { init(id, config) { ... } }`
    - Accept config.options.customTitle for overall title, showLegend toggle

    Update vite.config.ts for multi-entry builds:
    - Change from single entry to multiple entries using object format:
      ```
      entry: {
        'weekly-bar-chart': resolve(__dirname, 'src/widget/index.ts'),
        'stats-card': resolve(__dirname, 'src/widgets/stats-card/index.ts'),
        'comparison-chart': resolve(__dirname, 'src/widgets/comparison-chart/index.ts'),
      }
      ```
    - IMPORTANT: Vite IIFE mode does NOT support multiple entry points simultaneously. Use a build configuration that produces separate builds OR switch to a custom build script that runs Vite multiple times.
    - Recommended approach: Keep existing single-entry config for weekly-bar-chart, add a separate vite build config file (vite.widgets.config.ts) or use Vite's `build.lib` with a shell script that builds each widget separately.
    - Alternative (simpler): Create separate vite config objects and export based on env var, OR use rollup directly.
    - Simplest approach matching Phase 2 pattern: Create a build-widgets.ts script that programmatically calls `vite.build()` for each widget entry point with its own config (name, entry, outDir). This avoids complex multi-config files while producing the same IIFE bundles.
    - Output: dist/widgets/stats-card.js, dist/widgets/comparison-chart.js (separate from existing dist/widget/weekly-bar-chart.iife.js)
    - Add npm script "build-widgets": builds all new widgets

    Update tsconfig.widget.json if needed to include src/widgets/ path alongside existing src/widget/.
  </action>
  <verify>
    Run the widget build command. Verify:
    - dist/widgets/stats-card.js exists and is a valid IIFE bundle
    - dist/widgets/comparison-chart.js exists and is a valid IIFE bundle
    - Existing dist/widget/weekly-bar-chart.iife.js still builds correctly (no regression)
    - `npx tsc --noEmit` passes
  </verify>
  <done>
    ComparisonChart widget renders year-over-year grouped bars and seasonal trend lines from static JSON. Vite build produces separate IIFE bundles for each widget. All existing builds still work.
  </done>
</task>

</tasks>

<verification>
- TypeScript compiles without errors
- StatsCard IIFE bundle loads in browser and renders card with totals
- ComparisonChart IIFE bundle loads in browser and renders two charts
- Both widgets use Shadow DOM for style isolation
- Both accept WidgetConfig for customization
- Existing weekly-bar-chart build is not broken
</verification>

<success_criteria>
- Two new widget IIFE bundles produced: stats-card.js and comparison-chart.js
- StatsCard displays all-time totals and year-over-year delta
- ComparisonChart displays grouped bar chart and seasonal line chart
- Widgets accept config for colors, sizes, and options
- Consistent init API: StatsCard.init(id, config), ComparisonChart.init(id, config)
</success_criteria>

<output>
After completion, create `.planning/phases/03-advanced-analytics-widget-library/03-03-SUMMARY.md`
</output>

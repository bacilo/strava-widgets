---
phase: 03-advanced-analytics-widget-library
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/analytics/streak-utils.ts
  - src/analytics/streak-utils.test.ts
autonomous: true

must_haves:
  truths:
    - "Streak calculator correctly identifies consecutive run days from activity dates"
    - "Multiple runs on the same day count as one streak day"
    - "Current streak resets to 0 if last run was more than 1 day ago"
    - "Weekly consistency counts weeks meeting a configurable minimum run threshold"
  artifacts:
    - path: "src/analytics/streak-utils.ts"
      provides: "Streak calculation functions"
      exports: ["calculateDailyStreaks", "calculateWeeklyConsistency"]
    - path: "src/analytics/streak-utils.test.ts"
      provides: "Test coverage for streak edge cases"
      min_lines: 80
  key_links:
    - from: "src/analytics/streak-utils.ts"
      to: "Date UTC methods"
      via: "UTC normalization for day comparison"
      pattern: "getUTCFullYear|getUTCMonth|getUTCDate"
---

<objective>
TDD implementation of streak calculation algorithms for daily running streaks and weekly consistency streaks.

Purpose: Streak logic has well-defined inputs (array of dates) and outputs (streak counts) with subtle edge cases (same-day dedup, "yesterday counts" for current streak, partial weeks). TDD ensures correctness before integration into the stats pipeline.

Output: Tested streak-utils.ts with calculateDailyStreaks and calculateWeeklyConsistency functions.
</objective>

<execution_context>
@/Users/pedf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pedf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-advanced-analytics-widget-library/03-RESEARCH.md

@src/analytics/date-utils.ts
</context>

<tasks>

<task type="tdd">
  <name>Task 1: TDD streak calculation algorithms</name>
  <files>src/analytics/streak-utils.ts, src/analytics/streak-utils.test.ts</files>
  <feature>
    <name>Streak Calculation Algorithms</name>
    <files>src/analytics/streak-utils.ts, src/analytics/streak-utils.test.ts</files>
    <behavior>
      calculateDailyStreaks(activityDates: Date[]): StreakResult
      - Input: Array of Date objects (activity start_date values, may have duplicates on same day)
      - Output: { currentStreak, longestStreak, withinCurrentStreak, currentStreakStart, longestStreakStart, longestStreakEnd }

      Cases:
      - Empty array -> { currentStreak: 0, longestStreak: 0, withinCurrentStreak: false, ... }
      - Single date today -> { currentStreak: 1, longestStreak: 1, withinCurrentStreak: true }
      - Single date 5 days ago -> { currentStreak: 0, longestStreak: 1, withinCurrentStreak: false }
      - 3 consecutive days ending yesterday -> { currentStreak: 3, longestStreak: 3, withinCurrentStreak: true }
      - 3 consecutive days ending 5 days ago -> { currentStreak: 0, longestStreak: 3, withinCurrentStreak: false }
      - [Jan 1, Jan 2, Jan 2, Jan 3] (duplicate Jan 2) -> longestStreak: 3 (deduplication)
      - [Jan 1, Jan 2, Jan 3, Jan 10, Jan 11, Jan 12, Jan 13] -> longestStreak: 4, currentStreak depends on "today"
      - Dates across month boundary [Jan 30, Jan 31, Feb 1] -> streak: 3

      calculateWeeklyConsistency(activityDates: Date[], minRunsPerWeek: number): WeeklyConsistencyResult
      - Input: Array of Date objects + threshold N (default 3)
      - Output: { currentConsistencyStreak, longestConsistencyStreak, totalConsistentWeeks, totalWeeks }

      Cases:
      - Empty array -> all zeros
      - 1 week with 3 runs, threshold 3 -> currentConsistencyStreak: 1
      - 3 consecutive weeks with 3+ runs each, threshold 3 -> currentConsistencyStreak: 3
      - [3-run week, 1-run week, 3-run week], threshold 3 -> longestConsistencyStreak: 1
      - Threshold 1: any week with a run counts

      All date comparisons MUST use UTC methods exclusively (getUTCFullYear, getUTCMonth, getUTCDate).
      Normalize dates to UTC midnight before comparison.
      Use getWeekStart from date-utils.ts for weekly grouping (Monday-start ISO weeks).
    </behavior>
    <implementation>
      1. Define StreakResult and WeeklyConsistencyResult interfaces
      2. calculateDailyStreaks: normalize dates to UTC midnight, deduplicate by day, sort ascending, iterate checking for consecutive days (exactly 86400000ms apart after normalization), track current and longest streaks, determine withinCurrentStreak by checking if last activity date is today or yesterday UTC
      3. calculateWeeklyConsistency: group dates by ISO week using getWeekStart, count runs per week, iterate weeks chronologically checking if each meets threshold, track current and longest consistency streaks
    </implementation>
  </feature>
  <verify>
    All test cases pass with `npx vitest run src/analytics/streak-utils.test.ts` (or tsx-based test runner).
    No local timezone methods used (grep for getDay, getDate, getMonth, getFullYear without UTC prefix should find nothing in streak-utils.ts).
  </verify>
  <done>
    calculateDailyStreaks and calculateWeeklyConsistency implemented and tested. All edge cases covered: empty input, single day, consecutive days, gaps, same-day duplicates, month boundary crossings, configurable weekly threshold. All UTC methods.
  </done>
</task>

</tasks>

<verification>
- All test cases pass with `npx vitest run src/analytics/streak-utils.test.ts` (or tsx-based test runner)
- No local timezone methods used (grep for getDay, getDate, getMonth, getFullYear without UTC prefix should find nothing in streak-utils.ts)
</verification>

<success_criteria>
- calculateDailyStreaks handles empty input, single day, consecutive days, gaps, same-day duplicates, and month boundary crossings
- calculateWeeklyConsistency handles empty input, single week, consecutive consistent weeks, gaps, and configurable threshold
- "withinCurrentStreak" is true only if last activity was today or yesterday UTC
- All date operations use UTC methods exclusively
</success_criteria>

<output>
After completion, create `.planning/phases/03-advanced-analytics-widget-library/03-01-SUMMARY.md`
</output>

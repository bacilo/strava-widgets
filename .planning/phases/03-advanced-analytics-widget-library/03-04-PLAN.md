---
phase: 03-advanced-analytics-widget-library
plan: 04
type: execute
wave: 3
depends_on: ["03-01", "03-03"]
files_modified:
  - src/widgets/streak-widget/index.ts
  - src/widgets/streak-widget/chart-config.ts
  - src/analytics/compute-advanced-stats.ts
  - src/index.ts
  - public/test-widgets.html
  - vite.config.ts
autonomous: false

must_haves:
  truths:
    - "Streak widget displays current streak, longest streak, and weekly consistency numbers"
    - "Streak widget shows time-of-day radar chart with morning/afternoon/evening/night distribution"
    - "Streaks.json contains real streak data computed from activity dates"
    - "All widgets render correctly on a single test page without interfering with each other"
    - "Widgets render correctly in both Jekyll-style and Astro-style embedding contexts"
  artifacts:
    - path: "src/widgets/streak-widget/index.ts"
      provides: "Streak and patterns widget"
      contains: "StreakWidget"
    - path: "src/widgets/streak-widget/chart-config.ts"
      provides: "Radar chart for time-of-day patterns"
      contains: "RadarController"
    - path: "data/stats/streaks.json"
      provides: "Computed streak data"
      contains: "currentStreak"
    - path: "public/test-widgets.html"
      provides: "Comprehensive test page for all widgets"
      min_lines: 50
  key_links:
    - from: "src/widgets/streak-widget/index.ts"
      to: "data/stats/streaks.json"
      via: "fetch from dataUrl"
      pattern: "fetch.*dataUrl"
    - from: "src/widgets/streak-widget/chart-config.ts"
      to: "chart.js"
      via: "tree-shaken radar chart imports"
      pattern: "RadarController|RadialLinearScale"
    - from: "src/analytics/compute-advanced-stats.ts"
      to: "src/analytics/streak-utils.ts"
      via: "import for streak computation"
      pattern: "import.*streak-utils"
    - from: "public/test-widgets.html"
      to: "dist/widgets/"
      via: "script tags for all widget bundles"
      pattern: "script.*stats-card|comparison-chart|streak-widget"
---

<objective>
Build the streak/patterns widget with radar chart, integrate streak calculation into the stats pipeline, and create a comprehensive test page demonstrating all widgets with Jekyll and Astro embedding patterns.

Purpose: Completes the widget library with the final widget type and proves all widgets work together on a single page. The test page validates WIDG-06 (Jekyll/Astro compatibility) by simulating both contexts.

Output: StreakWidget with radar chart, streaks.json with real data, test-widgets.html showing all 4 widget types.
</objective>

<execution_context>
@/Users/pedf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pedf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-advanced-analytics-widget-library/03-RESEARCH.md
@.planning/phases/03-advanced-analytics-widget-library/03-01-SUMMARY.md
@.planning/phases/03-advanced-analytics-widget-library/03-02-SUMMARY.md
@.planning/phases/03-advanced-analytics-widget-library/03-03-SUMMARY.md

@src/analytics/streak-utils.ts
@src/widgets/shared/widget-base.ts
@src/types/widget-config.types.ts
@src/types/analytics.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate streak calculation into stats pipeline and build streak widget</name>
  <files>src/analytics/compute-advanced-stats.ts, src/index.ts, src/widgets/streak-widget/index.ts, src/widgets/streak-widget/chart-config.ts</files>
  <action>
    Update src/analytics/compute-advanced-stats.ts to:
    - Import calculateDailyStreaks and calculateWeeklyConsistency from streak-utils.ts
    - Extract activity start_date values as Date objects
    - Call calculateDailyStreaks with activity dates
    - Call calculateWeeklyConsistency with activity dates and threshold 3 (default)
    - Write combined result to data/stats/streaks.json as StreakData type
    - Update the console output to show streak info

    Create src/widgets/streak-widget/chart-config.ts:
    - Tree-shaken Chart.js imports for radar chart ONLY:
      RadarController, RadialLinearScale, PointElement, LineElement, Filler, Tooltip, Legend
    - Register only radar components
    - Export createTimeOfDayRadarChart(canvas, TimeOfDayPattern[], config): creates radar chart with 4 data points (morning/afternoon/evening/night)
    - Chart options: responsive, aspectRatio 1.5, scales.r.beginAtZero true (CRITICAL per research pitfall 4), circular grid lines
    - Tooltip shows run count, total km, and percentage for each time period
    - Default colors: Strava orange fill (rgba(252, 76, 2, 0.2)) with solid border

    Create src/widgets/streak-widget/index.ts:
    - Extends WidgetBase
    - Fetches TWO data files: streaks.json (primary dataUrl) and time-of-day.json (secondary)
    - Renders a two-section layout:
      * Top section: streak stats in a card-style layout
        - Current streak: "X days" with fire emoji or dash if 0
        - Longest streak: "X days" with date range
        - Weekly consistency: "X consecutive weeks with 3+ runs"
        - Longest weekly consistency: "X weeks"
      * Bottom section: time-of-day radar chart
    - CSS custom properties for theming from config
    - Inline styles following Phase 2 pattern
    - Expose global: `(window as any).StreakWidget = { init(id, config) { ... } }`
  </action>
  <verify>
    Run `npm run build && npm run compute-advanced-stats` to generate streaks.json with real data.
    Verify data/stats/streaks.json contains currentStreak, longestStreak, and weeklyConsistency fields.
    Build the streak widget and verify dist/widgets/streak-widget.js exists.
  </verify>
  <done>
    Streak data computed from real activities and saved to streaks.json. StreakWidget renders streak numbers and time-of-day radar chart. IIFE bundle produced.
  </done>
</task>

<task type="auto">
  <name>Task 2: Comprehensive test page with all widgets and Jekyll/Astro embedding patterns</name>
  <files>public/test-widgets.html, vite.config.ts</files>
  <action>
    Update vite.config.ts (or the widget build script from Plan 03) to include streak-widget as an additional entry point, producing dist/widgets/streak-widget.js.

    Create public/test-widgets.html that:
    1. Has a title "Strava Analytics Widget Library - Test Page"
    2. Applies deliberately different host page styles (serif font, colored background) to prove Shadow DOM isolation
    3. Embeds ALL 4 widgets on one page:
       - WeeklyBarChart (existing Phase 2 widget)
       - StatsCard (Plan 03)
       - ComparisonChart (Plan 03)
       - StreakWidget (this plan)
    4. Each widget in its own section with heading and container div
    5. Loads widget scripts from relative paths (dist/widget/ and dist/widgets/)
    6. Loads data from relative paths (data/stats/)
    7. Initializes each with the consistent .init(containerId, config) API
    8. Demonstrates configuration: one widget with default colors, another with custom dark theme colors
    9. Includes TWO embedding context sections at bottom:
       - "Jekyll Context": wraps a widget in a div with Jekyll-typical styling (markdown-body class, GitHub Pages serif theme)
       - "Astro Context": wraps a widget in a div with Astro-typical styling (island container, scoped styles)
       These prove WIDG-06: widgets render correctly regardless of host page framework styling

    Include a comment block at top explaining how to test:
    ```
    <!-- To test: serve this directory and open in browser -->
    <!-- npx serve . -p 4173 -->
    ```
  </action>
  <verify>
    Rebuild all widgets. Start a local server: `npx serve . -p 4173 &`
    Open http://localhost:4173/public/test-widgets.html in a browser (or verify via curl that HTML is served).
    All 4 widget containers should exist with script tags.
  </verify>
  <done>
    Test page loads all 4 widget types. Widgets render in isolated Shadow DOMs. Jekyll and Astro context sections demonstrate framework-agnostic embedding. Host page styles do not leak into widgets.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Visual verification of complete widget library</name>
  <action>
    Human verifies the complete widget library renders correctly. All 4 widgets built and displayed on test page:
    1. WeeklyBarChart - bar chart of weekly running distance (Phase 2)
    2. StatsCard - summary card with totals and year-over-year comparison
    3. ComparisonChart - grouped bar chart (YoY) + seasonal trend line chart
    4. StreakWidget - streak numbers + time-of-day radar chart
    All widgets use Shadow DOM for style isolation and accept configuration via init(id, config).
  </action>
  <verify>
    1. Open http://localhost:4173/public/test-widgets.html in browser
    2. Verify WeeklyBarChart shows orange bars with weekly distances
    3. Verify StatsCard shows total km, runs, hours, and YoY comparison
    4. Verify ComparisonChart shows grouped bars (per year) and seasonal line chart
    5. Verify StreakWidget shows streak numbers and radar chart with 4 time-of-day data points
    6. Verify host page serif font does NOT affect widget text (Shadow DOM isolation)
    7. Scroll to Jekyll/Astro sections and verify widgets render correctly there too
    8. Check browser console for any errors
  </verify>
  <done>User confirms all 4 widgets render correctly, Shadow DOM isolation works, and Jekyll/Astro contexts show proper rendering.</done>
</task>

</tasks>

<verification>
- data/stats/streaks.json exists with valid streak data
- dist/widgets/streak-widget.js exists as IIFE bundle
- public/test-widgets.html loads all 4 widgets
- All widgets use Shadow DOM
- No console errors on test page
- Widgets render in Jekyll and Astro context sections
</verification>

<success_criteria>
- StreakWidget displays current/longest daily streaks and weekly consistency
- Radar chart shows time-of-day distribution across 4 periods
- All 4 widget types render on a single test page without conflicts
- Jekyll and Astro embedding contexts prove framework-agnostic rendering
- User visually confirms all widgets look correct
</success_criteria>

<output>
After completion, create `.planning/phases/03-advanced-analytics-widget-library/03-04-SUMMARY.md`
</output>

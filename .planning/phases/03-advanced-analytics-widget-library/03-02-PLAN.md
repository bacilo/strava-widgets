---
phase: 03-advanced-analytics-widget-library
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/analytics.types.ts
  - src/analytics/compute-advanced-stats.ts
  - src/index.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Year-over-year JSON contains monthly totals grouped by year for km, runs, and hours"
    - "Time-of-day JSON contains run counts and distances for morning, afternoon, evening, and night buckets"
    - "Seasonal trends JSON contains monthly volume data across multiple years"
  artifacts:
    - path: "src/analytics/compute-advanced-stats.ts"
      provides: "Advanced statistics computation"
      exports: ["computeAdvancedStats"]
    - path: "src/types/analytics.types.ts"
      provides: "Type definitions for advanced stats"
      contains: "YearOverYearData"
  key_links:
    - from: "src/analytics/compute-advanced-stats.ts"
      to: "data/stats/"
      via: "fs.writeFile for JSON output"
      pattern: "writeFile.*year-over-year|time-of-day|seasonal-trends"
    - from: "src/analytics/compute-advanced-stats.ts"
      to: "src/analytics/date-utils.ts"
      via: "import getWeekStart, getMonthStart"
      pattern: "import.*date-utils"
    - from: "src/index.ts"
      to: "src/analytics/compute-advanced-stats.ts"
      via: "CLI command integration"
      pattern: "computeAdvancedStats|compute-advanced-stats"
---

<objective>
Compute advanced statistics (year-over-year comparisons, time-of-day patterns, seasonal trends) from activity data and output as static JSON files.

Purpose: These JSON files feed the widget library. Year-over-year data enables comparison charts, time-of-day data enables radar/pattern visualization, and seasonal trends enable multi-year line charts.

Output: compute-advanced-stats.ts generating 3 new JSON files in data/stats/, new type definitions, CLI command.
</objective>

<execution_context>
@/Users/pedf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pedf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-advanced-analytics-widget-library/03-RESEARCH.md

@src/analytics/compute-stats.ts
@src/analytics/date-utils.ts
@src/types/analytics.types.ts
@src/types/strava.types.ts
@src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Advanced analytics types and computation engine</name>
  <files>src/types/analytics.types.ts, src/analytics/compute-advanced-stats.ts</files>
  <action>
    Add new type definitions to src/types/analytics.types.ts (append, do not modify existing types):

    ```typescript
    // Year-over-year monthly comparison
    export interface YearOverYearMonth {
      month: number;        // 1-12
      monthLabel: string;   // "Jan", "Feb", ...
      years: Record<string, { totalKm: number; totalRuns: number; totalHours: number }>;
    }

    // Time-of-day pattern
    export interface TimeOfDayPattern {
      period: string;       // "Morning (6am-12pm)", "Afternoon (12pm-6pm)", "Evening (6pm-10pm)", "Night (10pm-6am)"
      runCount: number;
      totalKm: number;
      percentage: number;   // % of total runs
    }

    // Seasonal trends (monthly volume per year)
    export interface SeasonalTrendMonth {
      year: number;
      month: number;        // 1-12
      totalKm: number;
      totalRuns: number;
      totalHours: number;
    }

    // Streak data (output from streak-utils, stored in JSON)
    export interface StreakData {
      currentStreak: number;
      longestStreak: number;
      withinCurrentStreak: boolean;
      currentStreakStart: string;
      longestStreakStart: string;
      longestStreakEnd: string;
      weeklyConsistency: {
        currentStreak: number;
        longestStreak: number;
        totalConsistentWeeks: number;
        totalWeeks: number;
        minRunsPerWeek: number;
      };
    }
    ```

    Create src/analytics/compute-advanced-stats.ts that:

    1. Reads all Run activity JSON files from data/activities/ (same pattern as compute-stats.ts)
    2. Computes year-over-year data:
       - Group activities by year and month using UTC methods
       - For each month (1-12), aggregate totalKm (distance/1000), totalRuns (count), totalHours (moving_time/3600) per year
       - Show up to 3 most recent years with data
       - Pre-fill all 12 months with zeros for each year (prevents Chart.js misalignment)
       - Output as YearOverYearMonth[] to data/stats/year-over-year.json
    3. Computes time-of-day patterns:
       - Bucket activities by UTC hour: Morning 6-11, Afternoon 12-17, Evening 18-21, Night 22-5
       - Use getUTCHours() on start_date (not local time)
       - Calculate percentage of total runs per bucket
       - Output as TimeOfDayPattern[] to data/stats/time-of-day.json
    4. Computes seasonal trends:
       - Group by year and month, aggregate totalKm, totalRuns, totalHours
       - Output as SeasonalTrendMonth[] to data/stats/seasonal-trends.json
       - Show up to 3 most recent years
    5. Does NOT compute streaks (that is Plan 01's responsibility) - but does write a placeholder streaks.json that Plan 03+ will update once streak-utils is integrated

    Export a single async function `computeAdvancedStats(options?)` following the same pattern as computeAllStats in compute-stats.ts.
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify types compile. Then build and run:
    `npm run build && node dist/analytics/compute-advanced-stats.js` (or integrate via CLI and test).
    Verify data/stats/year-over-year.json, data/stats/time-of-day.json, and data/stats/seasonal-trends.json exist and contain valid JSON arrays.
  </verify>
  <done>
    Three new JSON files generated with real activity data. Year-over-year has 12 months with per-year breakdowns. Time-of-day has 4 buckets summing to 100%. Seasonal trends has monthly entries grouped by year.
  </done>
</task>

<task type="auto">
  <name>Task 2: CLI integration and combined compute command</name>
  <files>src/index.ts, package.json</files>
  <action>
    Update src/index.ts to add a 'compute-advanced-stats' command in the CLI switch statement, following the exact same pattern as the existing 'compute-stats' command. Import computeAdvancedStats from './analytics/compute-advanced-stats.js'.

    Also add a 'compute-all-stats' convenience command that runs BOTH computeAllStats and computeAdvancedStats sequentially, so users can regenerate everything with one command.

    Add npm scripts to package.json:
    - "compute-advanced-stats": "node dist/index.js compute-advanced-stats"
    - "compute-all-stats": "node dist/index.js compute-all-stats"

    Build with `npm run build`, then run `npm run compute-advanced-stats` to generate the JSON files.
  </action>
  <verify>
    Run `npm run build && npm run compute-advanced-stats` and verify it completes without errors and generates the 3 JSON files.
    Run `npm run compute-all-stats` and verify both basic and advanced stats are generated.
    Check file contents: `node -e "const d=require('./data/stats/year-over-year.json'); console.log(d.length, 'months')"`
  </verify>
  <done>
    CLI commands `compute-advanced-stats` and `compute-all-stats` work. Running `npm run compute-all-stats` generates all 8+ stats JSON files (5 from Phase 2 + 3 new).
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with no type errors
- data/stats/year-over-year.json exists with 12 entries, each having a `years` object with year keys
- data/stats/time-of-day.json exists with 4 entries whose percentages sum to ~100%
- data/stats/seasonal-trends.json exists with monthly entries across multiple years
- All date operations in compute-advanced-stats.ts use UTC methods (no getMonth, getDate, getHours without UTC prefix)
</verification>

<success_criteria>
- Year-over-year data correctly groups 1,808 activities by month and year with all 12 months pre-filled
- Time-of-day buckets correctly categorize activities using UTC hours
- Seasonal trends data shows monthly volume across up to 3 most recent years
- CLI commands work for both individual and combined stats generation
</success_criteria>

<output>
After completion, create `.planning/phases/03-advanced-analytics-widget-library/03-02-SUMMARY.md`
</output>

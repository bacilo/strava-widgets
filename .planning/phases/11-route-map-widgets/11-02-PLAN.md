---
phase: 11-route-map-widgets
plan: 02
type: execute
wave: 2
depends_on: [11-01]
files_modified:
  - src/widgets/single-run-map/index.ts
  - src/widgets/multi-run-overlay/index.ts
  - scripts/build-widgets.mjs
autonomous: true
requirements: [ROUTE-01, ROUTE-03, ROUTE-04, ROUTE-05]

must_haves:
  truths:
    - "User can view a single run's route on an interactive map with zoom/pan"
    - "User can see the latest N runs overlaid on a single map with distinct colors"
    - "Route auto-fits to viewport on load without manual zooming"
    - "User can click a route to see distance, date, and pace in a popup"
  artifacts:
    - path: "src/widgets/single-run-map/index.ts"
      provides: "Single-run map widget showing one activity's route"
      min_lines: 50
    - path: "src/widgets/multi-run-overlay/index.ts"
      provides: "Multi-run overlay widget showing latest N runs on one map"
      min_lines: 60
  key_links:
    - from: "src/widgets/single-run-map/index.ts"
      to: "src/widgets/shared/route-utils.ts"
      via: "RouteRenderer.renderRoute()"
      pattern: "RouteRenderer\\.renderRoute"
    - from: "src/widgets/multi-run-overlay/index.ts"
      to: "src/widgets/shared/route-utils.ts"
      via: "RouteRenderer.renderMultipleRoutes()"
      pattern: "RouteRenderer\\.renderMultipleRoutes"
    - from: "src/widgets/single-run-map/index.ts"
      to: "data/routes/route-list.json"
      via: "fetchData to get single activity route data"
      pattern: "fetchData|data-url"
    - from: "src/widgets/multi-run-overlay/index.ts"
      to: "data/routes/latest-runs.json"
      via: "fetchData to get latest N runs"
      pattern: "latest-runs\\.json"
---

<objective>
Build the single-run map widget and multi-run overlay widget using the shared RouteRenderer utility.

Purpose: ROUTE-01 (single run map with zoom/pan), ROUTE-03 (latest N runs overlaid), ROUTE-04 (auto-fit viewport), ROUTE-05 (click popup with distance/date/pace). These two widgets share the same rendering foundation and can be built together efficiently.

Output:
- `src/widgets/single-run-map/index.ts` — `<single-run-map>` Custom Element
- `src/widgets/multi-run-overlay/index.ts` — `<multi-run-overlay>` Custom Element
- Updated `scripts/build-widgets.mjs` with both new widget entries
</objective>

<execution_context>
@/Users/pedf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pedf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-route-map-widgets/11-RESEARCH.md
@.planning/phases/11-route-map-widgets/11-01-SUMMARY.md
@src/widgets/shared/widget-base.ts
@src/widgets/shared/route-utils.ts
@src/widgets/map-test-widget/index.ts
@scripts/build-widgets.mjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create single-run map widget</name>
  <files>src/widgets/single-run-map/index.ts, scripts/build-widgets.mjs</files>
  <action>
Create `src/widgets/single-run-map/index.ts`:

**SingleRunMapElement** extends WidgetBase. Displays a single activity's route on an interactive Leaflet map.

**Imports** (follow map-test-widget pattern exactly):
```typescript
import L from 'leaflet';
import 'leaflet/dist/leaflet.css';
import { WidgetBase } from '../shared/widget-base.js';
import { RouteRenderer, RouteData } from '../shared/route-utils.js';
import markerIcon from 'leaflet/dist/images/marker-icon.png';
import markerIcon2x from 'leaflet/dist/images/marker-icon-2x.png';
import markerShadow from 'leaflet/dist/images/marker-shadow.png';
```

**Marker icon fix** (same as map-test-widget):
```typescript
delete (L.Icon.Default.prototype as any)._getIconUrl;
L.Icon.Default.mergeOptions({ iconUrl: markerIcon, iconRetinaUrl: markerIcon2x, shadowUrl: markerShadow });
```

**Widget behavior:**
- `dataUrl` getter returns `'data/routes/route-list.json'` (fallback, but typically uses `data-url` attribute pointing to a specific route)
- Supports `data-activity-id` attribute to select a specific activity from route-list.json
- `data-height` attribute for map container height (default: '400px')

**connectedCallback():** Call super.connectedCallback(). Do NOT create map here — wait for data in render().

**render(data):**
1. Clear shadow DOM content except style elements
2. Create map container div with height from `data-height` attribute (default 400px), width 100%, border-radius 8px, overflow hidden
3. If `data-activity-id` is set, find matching route from data array. If data is a single RouteData object (not array), use directly.
4. If no route found or no polyline, call showError('No route data available')
5. Initialize Leaflet map on container with default view [0, 0], zoom 2
6. Add OpenStreetMap tile layer with attribution and maxZoom: 19
7. Call `RouteRenderer.renderRoute(this.map, route, { showPopup: true, fitBounds: true })`
8. Call `RouteRenderer.addHoverEffect(polyline)` on returned polyline
9. Store map reference for cleanup

**disconnectedCallback():** Call map.remove() if map exists, set to null, call super.

**Register:** `WidgetBase.register('single-run-map', SingleRunMapElement)`

**Add to build-widgets.mjs** widgets array:
```javascript
{
  name: 'single-run-map',
  entry: resolve(__dirname, '../src/widgets/single-run-map/index.ts'),
  globalName: 'SingleRunMap',
  isMapWidget: true
}
```
  </action>
  <verify>
Run: `npx tsc --noEmit` — compiles without errors
Run: `npm run build-widgets` — builds successfully, dist/widgets/single-run-map.iife.js exists and is < 50KB
  </verify>
  <done>Single-run map widget renders one activity's route with zoom/pan, auto-fit viewport, hover effects, and click popup showing distance/date/pace</done>
</task>

<task type="auto">
  <name>Task 2: Create multi-run overlay widget</name>
  <files>src/widgets/multi-run-overlay/index.ts, scripts/build-widgets.mjs</files>
  <action>
Create `src/widgets/multi-run-overlay/index.ts`:

**MultiRunOverlayElement** extends WidgetBase. Displays the latest N runs overlaid on a single map with distinct colors.

**Imports** (same pattern as single-run-map):
```typescript
import L from 'leaflet';
import 'leaflet/dist/leaflet.css';
import { WidgetBase } from '../shared/widget-base.js';
import { RouteRenderer, RouteData } from '../shared/route-utils.js';
import markerIcon from 'leaflet/dist/images/marker-icon.png';
import markerIcon2x from 'leaflet/dist/images/marker-icon-2x.png';
import markerShadow from 'leaflet/dist/images/marker-shadow.png';
```

**Marker icon fix** (same pattern).

**Widget behavior:**
- `dataUrl` getter returns `'data/routes/latest-runs.json'`
- `data-count` attribute: number of routes to display (default 10, max from data)
- `data-height` attribute: map container height (default '500px')

**render(data: RouteData[]):**
1. Clear shadow DOM content except style elements
2. Create map container div with height from `data-height`, width 100%, border-radius 8px, overflow hidden
3. Slice data to `data-count` entries (parseInt from attribute, default 10)
4. If no routes, call showError('No route data available')
5. Initialize Leaflet map on container with default view [0, 0], zoom 2
6. Add OpenStreetMap tile layer
7. Call `RouteRenderer.renderMultipleRoutes(this.map, routes, { showPopup: true })` — this handles color distribution and combined bounds fitting
8. Store returned polylines array and map reference for cleanup
9. Add hover effects to each polyline via RouteRenderer.addHoverEffect()

**disconnectedCallback():** Remove all stored polylines, map.remove(), call super.

**Register:** `WidgetBase.register('multi-run-overlay', MultiRunOverlayElement)`

**Add to build-widgets.mjs** widgets array:
```javascript
{
  name: 'multi-run-overlay',
  entry: resolve(__dirname, '../src/widgets/multi-run-overlay/index.ts'),
  globalName: 'MultiRunOverlay',
  isMapWidget: true
}
```
  </action>
  <verify>
Run: `npx tsc --noEmit` — compiles without errors
Run: `npm run build-widgets` — builds successfully, dist/widgets/multi-run-overlay.iife.js exists and is < 50KB
Verify: All existing widget bundles still build (stats-card, comparison-chart, streak-widget, geo-stats-widget, geo-table-widget, map-test)
  </verify>
  <done>Multi-run overlay widget shows latest N runs with distinct HSL colors, combined auto-fit bounds, hover effects, and click popups showing distance/date/pace per route</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npm run build-widgets` succeeds with all widgets building
3. dist/widgets/single-run-map.iife.js exists and < 50KB
4. dist/widgets/multi-run-overlay.iife.js exists and < 50KB
5. Both widget bundles end with `}(L);` (Leaflet externalized)
6. All 8 widget bundles present in dist/widgets/
7. `npm test` passes (no regressions)
</verification>

<success_criteria>
- `<single-run-map data-url="route.json">` renders a single route with zoom/pan, auto-fit, hover, popup
- `<multi-run-overlay data-count="10">` renders latest 10 runs with distinct colors, combined bounds, popups
- Both widgets follow established map widget patterns (Leaflet CDN, Shadow DOM, CSS injection, marker icon fix)
- Bundle sizes < 50KB each
- Existing widgets unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/11-route-map-widgets/11-02-SUMMARY.md`
</output>

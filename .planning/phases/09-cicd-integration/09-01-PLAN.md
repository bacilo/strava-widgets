---
phase: 09-cicd-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/daily-refresh.yml
  - dist/widgets/index.html
autonomous: true

must_haves:
  truths:
    - "Geocoding runs automatically in GitHub Actions workflow on each build"
    - "Geographic statistics are computed and committed automatically (data/geo/*.json in file_pattern)"
    - "CI pipeline continues working if geocoding fails (continue-on-error on geocoding step)"
    - "Geographic table widget documentation visible on index.html with Custom Elements syntax"
  artifacts:
    - path: ".github/workflows/daily-refresh.yml"
      provides: "Extended CI/CD workflow with non-blocking geocoding step"
      contains: "continue-on-error: true"
    - path: "dist/widgets/index.html"
      provides: "Updated widget landing page with Custom Elements embed examples"
      contains: "strava-geo-table"
  key_links:
    - from: ".github/workflows/daily-refresh.yml"
      to: "npm run compute-geo-stats"
      via: "geocoding step with continue-on-error"
      pattern: "compute-geo-stats"
    - from: ".github/workflows/daily-refresh.yml"
      to: "data/geo/*.json"
      via: "git-auto-commit-action file_pattern"
      pattern: "data/geo/\\*\\.json"
---

<objective>
Extend the GitHub Actions CI/CD workflow to include non-blocking geocoding and update the widget landing page to use the Custom Elements API.

Purpose: Complete CI/CD integration so geographic data refreshes automatically alongside existing stats, and ensure the public-facing index.html shows correct widget embed syntax for all 5 widgets including geo-table-widget.
Output: Updated daily-refresh.yml with geocoding step, updated index.html with Custom Elements syntax.
</objective>

<execution_context>
@/Users/pedf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pedf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-cicd-integration/09-RESEARCH.md
@.github/workflows/daily-refresh.yml
@dist/widgets/index.html
@dist/widgets/test.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add non-blocking geocoding step to CI workflow and update commit patterns</name>
  <files>.github/workflows/daily-refresh.yml</files>
  <action>
Modify the existing daily-refresh.yml workflow to add geocoding support:

1. **Restructure stats computation for geocoding isolation.** The current "Process statistics" step runs `node dist/index.js compute-all-stats` which internally calls computeGeoStats. This means geocoding failures currently crash the entire stats computation. Instead:
   - Change the existing "Process statistics" step to run basic + advanced stats only: `node dist/index.js compute-stats && node dist/index.js compute-advanced-stats`
   - Add a NEW step after it for geocoding with error isolation:
     ```yaml
     - name: Compute geographic statistics
       id: geocode
       continue-on-error: true
       run: node dist/index.js compute-geo-stats

     - name: Warn on geocoding failure
       if: steps.geocode.outcome == 'failure'
       run: echo "::warning::Geocoding failed, widgets will use cached geo data"
     ```

2. **Update the git-auto-commit-action file_pattern** to include geographic data files. Change from:
   `'data/activities/*.json data/sync-state.json data/stats/*.json'`
   To:
   `'data/activities/*.json data/sync-state.json data/stats/*.json data/geo/*.json'`
   This ensures countries.json, cities.json, geo-metadata.json, and location-cache.json are committed.

IMPORTANT: Use `steps.geocode.outcome == 'failure'` (not `failure()`) because continue-on-error sets conclusion to success but outcome reflects the actual result. This is per GitHub Actions semantics and research pitfall #4.

Do NOT change any other steps (checkout, setup-node, install, tokens, fetch, compile, build-widgets, deploy). Only modify the stats step, add the geocoding steps, and update the commit file_pattern.
  </action>
  <verify>
Read the modified workflow file and verify:
1. The geocoding step has `id: geocode` and `continue-on-error: true`
2. The warning step uses `steps.geocode.outcome == 'failure'`
3. The file_pattern includes `data/geo/*.json`
4. Basic/advanced stats still run in a separate step without continue-on-error (they should fail the pipeline if broken)
5. YAML syntax is valid (proper indentation, no trailing spaces)
  </verify>
  <done>
Workflow has isolated geocoding step with continue-on-error that won't block pipeline on failure. Geographic data files are included in auto-commit pattern. Basic/advanced stats remain blocking (they're critical).
  </done>
</task>

<task type="auto">
  <name>Task 2: Update index.html with Custom Elements syntax and geo-table-widget</name>
  <files>dist/widgets/index.html</files>
  <action>
Rewrite the widget landing page (dist/widgets/index.html) to:

1. **Replace all .init() API examples with Custom Elements syntax.** The current index.html uses the old `window.StatsCard.init('strava-stats', {...})` pattern from Phase 3. Phase 7 migrated all widgets to Custom Elements. Update ALL widget examples to use the `<strava-*>` tag syntax.

2. **Widget embed examples to include (use bacilo.github.io/strava-widgets as the base URL):**

   - **Stats Card:**
     ```html
     <strava-stats-card
       data-url="https://bacilo.github.io/strava-widgets/data/stats/all-time-totals.json"
       data-secondary-url="https://bacilo.github.io/strava-widgets/data/stats/year-over-year.json"
       data-title="My Running Stats">
     </strava-stats-card>
     <script src="https://bacilo.github.io/strava-widgets/stats-card.iife.js"></script>
     ```

   - **Comparison Chart:**
     ```html
     <strava-comparison-chart
       data-url="https://bacilo.github.io/strava-widgets/data/stats/year-over-year.json"
       data-secondary-url="https://bacilo.github.io/strava-widgets/data/stats/seasonal-trends.json"
       data-title="Year-Over-Year Comparison">
     </strava-comparison-chart>
     <script src="https://bacilo.github.io/strava-widgets/comparison-chart.iife.js"></script>
     ```

   - **Streak Widget:**
     ```html
     <strava-streak-widget
       data-url="https://bacilo.github.io/strava-widgets/data/stats/streaks.json"
       data-secondary-url="https://bacilo.github.io/strava-widgets/data/stats/time-of-day.json"
       data-title="Running Streaks & Patterns">
     </strava-streak-widget>
     <script src="https://bacilo.github.io/strava-widgets/streak-widget.iife.js"></script>
     ```

   - **Geographic Statistics:**
     ```html
     <strava-geo-stats
       data-url="https://bacilo.github.io/strava-widgets/data/geo/countries.json"
       data-secondary-url="https://bacilo.github.io/strava-widgets/data/geo/cities.json"
       data-metadata-url="https://bacilo.github.io/strava-widgets/data/geo/geo-metadata.json"
       data-title="Where I've Run">
     </strava-geo-stats>
     <script src="https://bacilo.github.io/strava-widgets/geo-stats-widget.iife.js"></script>
     ```

   - **Geographic Table (NEW):**
     ```html
     <strava-geo-table
       data-url="https://bacilo.github.io/strava-widgets/data/geo/countries.json"
       data-dataset="countries"
       data-title="Countries I've Run In"
       data-rows-per-page="10">
     </strava-geo-table>
     <script src="https://bacilo.github.io/strava-widgets/geo-table-widget.iife.js"></script>
     ```

3. **Add a "View Test Page" link** in the footer pointing to `test.html` for developers who want to see all widgets rendered live.

4. **Keep existing page structure** (Strava orange header, white container, code blocks, footer). Just update the code examples inside `<pre><code>` blocks and add the geo-table-widget section.

5. **Keep Strava attribution** in footer ("Powered by Strava" with link to strava.com).

Do NOT use emojis in the HTML. Keep the existing clean design.
  </action>
  <verify>
Read the modified index.html and verify:
1. No `.init()` calls remain — all examples use Custom Elements `<strava-*>` tags
2. All 5 widgets have embed examples (stats-card, comparison-chart, streak-widget, geo-stats-widget, geo-table-widget)
3. Footer has "View Test Page" link to test.html
4. Footer has Strava attribution
5. HTML is valid (proper escaping in code blocks: &lt; and &gt; for angle brackets)
  </verify>
  <done>
index.html shows correct Custom Elements embed syntax for all 5 widgets including geo-table-widget. Test page link present in footer. Old .init() API examples fully replaced.
  </done>
</task>

</tasks>

<verification>
1. Read .github/workflows/daily-refresh.yml — geocoding step with continue-on-error: true, warning step with outcome check, file_pattern includes data/geo/*.json
2. Read dist/widgets/index.html — all 5 widgets documented with Custom Elements syntax, no .init() API references, geo-table-widget section present
3. Verify the workflow has proper step ordering: compile → stats → geocode (continue-on-error) → build-widgets → commit → deploy
</verification>

<success_criteria>
- CI workflow has non-blocking geocoding step that won't halt pipeline on failure
- Geographic data files (data/geo/*.json) are included in auto-commit pattern
- Widget landing page shows Custom Elements syntax for all 5 widgets
- Geo-table-widget documented on index.html
- Test page linked from index.html footer
</success_criteria>

<output>
After completion, create `.planning/phases/09-cicd-integration/09-01-SUMMARY.md`
</output>

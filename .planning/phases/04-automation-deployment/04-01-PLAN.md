---
phase: 04-automation-deployment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .gitignore
  - .github/workflows/daily-refresh.yml
  - scripts/ci-setup-tokens.mjs
  - dist/widgets/index.html
  - package.json
autonomous: false

user_setup:
  - service: github
    why: "Repository hosting, CI/CD, and widget deployment"
    env_vars:
      - name: STRAVA_CLIENT_ID
        source: "https://www.strava.com/settings/api -> Client ID"
      - name: STRAVA_CLIENT_SECRET
        source: "https://www.strava.com/settings/api -> Client Secret"
      - name: STRAVA_REFRESH_TOKEN
        source: "Local data/tokens.json -> refresh_token field (only needed for first CI run)"
    dashboard_config:
      - task: "Create GitHub repository (must be PRIVATE - contains tokens and personal data)"
        location: "https://github.com/new"
      - task: "Add repository secrets: STRAVA_CLIENT_ID, STRAVA_CLIENT_SECRET, STRAVA_REFRESH_TOKEN"
        location: "Repo -> Settings -> Secrets and variables -> Actions -> New repository secret"
      - task: "Enable GitHub Pages with 'GitHub Actions' as source"
        location: "Repo -> Settings -> Pages -> Source -> GitHub Actions"

must_haves:
  truths:
    - "Workflow runs daily at scheduled time to fetch new Strava activities"
    - "Workflow processes statistics and regenerates all widgets automatically"
    - "Generated widgets are committed and deployed to GitHub Pages"
    - "Workflow handles fetch errors gracefully without blocking widget rebuild"
    - "User can manually trigger workflow from GitHub Actions UI"
  artifacts:
    - path: ".github/workflows/daily-refresh.yml"
      provides: "Complete CI/CD pipeline: fetch -> process -> build -> commit -> deploy"
      contains: "schedule"
    - path: "scripts/ci-setup-tokens.mjs"
      provides: "Creates data/tokens.json from environment variables for CI"
      exports: ["default script execution"]
    - path: "dist/widgets/index.html"
      provides: "GitHub Pages landing page listing available widgets"
      contains: "stats-card"
  key_links:
    - from: ".github/workflows/daily-refresh.yml"
      to: "scripts/ci-setup-tokens.mjs"
      via: "node scripts/ci-setup-tokens.mjs step in workflow"
      pattern: "ci-setup-tokens"
    - from: ".github/workflows/daily-refresh.yml"
      to: "npm run sync"
      via: "env vars STRAVA_CLIENT_ID, STRAVA_CLIENT_SECRET passed from secrets"
      pattern: "secrets\\.STRAVA"
    - from: ".github/workflows/daily-refresh.yml"
      to: "dist/widgets/"
      via: "peaceiris/actions-gh-pages publish_dir"
      pattern: "publish_dir.*dist/widgets"
---

<objective>
Create a GitHub Actions workflow that automates the daily data refresh pipeline (fetch activities from Strava, compute statistics, build widgets) and deploys updated widgets to GitHub Pages.

Purpose: Eliminate manual intervention for data updates -- the system runs daily, fetching new activities, regenerating stats and widgets, and publishing them automatically.
Output: Complete CI/CD workflow file, CI token setup script, GitHub Pages landing page.
</objective>

<execution_context>
@/Users/pedf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pedf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-automation-deployment/04-RESEARCH.md
@package.json
@.gitignore
@src/index.ts
@src/config/strava.config.ts
@src/auth/strava-oauth.ts
@scripts/build-widgets.mjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: CI token setup script, .gitignore update, and npm script aliases</name>
  <files>
    scripts/ci-setup-tokens.mjs
    .gitignore
    package.json
  </files>
  <action>
    1. Create `scripts/ci-setup-tokens.mjs` -- a Node.js script that prepares the token file for CI:
       - Reads STRAVA_REFRESH_TOKEN from process.env (required, exit 1 if missing)
       - First checks if `data/tokens.json` already exists -- if it does, log "tokens.json already exists, skipping setup" and exit 0 (the committed tokens from a prior CI run are more current than the secret)
       - If tokens.json does NOT exist: write `data/tokens.json` with structure: `{ "access_token": "", "refresh_token": "<from env>", "expires_at": 0 }`
       - Setting expires_at to 0 forces StravaOAuth.getValidAccessToken() to refresh immediately, obtaining a valid access token
       - Creates `data/` directory if it doesn't exist (using fs.mkdirSync with recursive:true)
       - Logs success message to stdout
       - Script should be ~25 lines, use fs and path from Node.js built-ins only

    2. Update `.gitignore`:
       - Remove the blanket `data/` ignore
       - Add specific ignores instead:
         - `data/tokens.json` (contains secrets, must never be committed)
         - `.env` (keep existing)
       - This means `data/activities/`, `data/sync-state.json`, and `data/stats/` WILL be tracked in git
       - This is essential: CI needs committed activity data for incremental sync, and committed sync-state.json to know where to resume
       - Keep `dist/` in gitignore (widgets are built fresh each run, deployed via gh-pages action to separate branch)
       - Keep `node_modules/` and `.DS_Store`

    3. Update `package.json` scripts:
       - Add `"fetch": "npm run build && node dist/index.js sync"` -- compiles TS then runs sync (used by workflow)
       - Add `"process": "npm run build && node dist/index.js compute-all-stats"` -- compiles TS then runs stats computation (used by workflow)
       - Keep all existing scripts unchanged

    Why this approach: The existing StravaOAuth class reads tokens from data/tokens.json and writes back rotated tokens there. In CI, we bootstrap this file from a GitHub Secret on first run only. After sync completes, the new tokens.json (with rotated refresh token) is committed back to the repo by the workflow, so subsequent runs use the committed token directly. The STRAVA_REFRESH_TOKEN secret is only needed for bootstrapping.
  </action>
  <verify>
    - `cat scripts/ci-setup-tokens.mjs` shows the script with existence check
    - `cat .gitignore` shows data/tokens.json ignored but NOT data/ blanket
    - `cat package.json | grep -E '"fetch"|"process"'` shows both new scripts
    - `STRAVA_REFRESH_TOKEN=test_token node scripts/ci-setup-tokens.mjs` creates data/tokens.json with the test token and expires_at=0
  </verify>
  <done>
    CI helper script creates tokens.json from env var (only if not already present). Gitignore allows tracking activities, stats, and sync-state while excluding tokens. Two new npm scripts (fetch, process) provide clean CI pipeline steps.
  </done>
</task>

<task type="auto">
  <name>Task 2: GitHub Actions daily-refresh workflow and Pages landing page</name>
  <files>
    .github/workflows/daily-refresh.yml
    dist/widgets/index.html
  </files>
  <action>
    1. Create `.github/workflows/daily-refresh.yml` with the following structure:

       **Triggers:**
       - `schedule: cron '0 5 * * *'` (5 AM UTC daily -- morning in Europe, after overnight Strava uploads)
       - `workflow_dispatch` with optional boolean input `force_rebuild` (description: "Force rebuild all widgets")

       **Concurrency:**
       - group: `widget-refresh`
       - cancel-in-progress: false (let current run finish)

       **Permissions (minimal):**
       - contents: write (commit generated files)
       - pages: write (deploy to GitHub Pages)
       - id-token: write (OIDC for Pages)

       **Single job `refresh-and-deploy`:**
       - runs-on: ubuntu-latest
       - timeout-minutes: 30

       **Steps (in order):**

       a. `Checkout repository` -- actions/checkout@v6

       b. `Setup Node.js` -- actions/setup-node@v6 with node-version '22' and cache 'npm'
          (Use Node 22 LTS for stability in CI, not 24 which is current/unstable)

       c. `Install dependencies` -- `npm ci`

       d. `Setup tokens for Strava API` -- run `node scripts/ci-setup-tokens.mjs`
          env: STRAVA_REFRESH_TOKEN from secrets.STRAVA_REFRESH_TOKEN

       e. `Fetch new activities from Strava` -- run `npm run fetch`
          id: fetch
          continue-on-error: true (use cached data if Strava API fails)
          env: STRAVA_CLIENT_ID from secrets.STRAVA_CLIENT_ID, STRAVA_CLIENT_SECRET from secrets.STRAVA_CLIENT_SECRET

       f. `Warn on fetch failure` -- run `echo "::warning::Strava fetch failed, rebuilding with existing data"`
          if: steps.fetch.outcome == 'failure'

       g. `Compile TypeScript` -- run `npm run build`

       h. `Process statistics` -- run `node dist/index.js compute-all-stats`

       i. `Build widgets` -- run `npm run build-widgets`

       j. `Commit updated data and stats` -- stefanzweifel/git-auto-commit-action@v7
          commit_message: "chore: update activities and stats [skip ci]"
          file_pattern: "data/activities/*.json data/sync-state.json data/stats/*.json"
          commit_user_name: "github-actions[bot]"
          commit_user_email: "github-actions[bot]@users.noreply.github.com"

       k. `Deploy widgets to GitHub Pages` -- peaceiris/actions-gh-pages@v4
          github_token from secrets.GITHUB_TOKEN
          publish_dir: ./dist/widgets
          enable_jekyll: false
          (Do NOT set cname -- user can add later if needed)

    2. Create `dist/widgets/index.html` -- a minimal landing page for GitHub Pages:
       - Simple HTML5 page with title "Strava Analytics Widgets"
       - List the 3 available widgets with their script tag embed codes:
         - stats-card.iife.js
         - comparison-chart.iife.js
         - streak-widget.iife.js
       - For each widget, show the embed code as a `<pre><code>` block
       - Minimal inline CSS for readability (max-width container, monospace code blocks, light background on code)
       - Note at bottom: "Auto-updated daily by GitHub Actions"
       - This page serves as both documentation and proof that deployment works

    Important notes:
    - Use `npm ci` not `npm install` (deterministic, faster in CI)
    - The `[skip ci]` in commit message prevents recursive workflow triggers
    - The `continue-on-error: true` on fetch step means widgets still rebuild from existing data if Strava API is down
    - Do NOT include STRAVA_REFRESH_TOKEN in the fetch step env -- it's only used by the setup-tokens script (step d)
    - The fetch step needs STRAVA_CLIENT_ID and STRAVA_CLIENT_SECRET because the sync command uses these to refresh the OAuth access token
  </action>
  <verify>
    - `cat .github/workflows/daily-refresh.yml` shows valid YAML with schedule, workflow_dispatch, all steps
    - YAML contains `actions/checkout@v6`, `actions/setup-node@v6`, `peaceiris/actions-gh-pages@v4`, `stefanzweifel/git-auto-commit-action@v7`
    - YAML contains `concurrency`, `timeout-minutes`, `permissions`, `continue-on-error`
    - YAML contains `[skip ci]` in commit message
    - `cat dist/widgets/index.html` shows widget listing page
    - No secrets are hardcoded in any file (grep for actual token values returns nothing)
  </verify>
  <done>
    GitHub Actions workflow exists with daily schedule + manual trigger, runs full pipeline (setup tokens, fetch activities, process stats, build widgets, commit data, deploy to Pages). Landing page provides widget embed documentation. Workflow uses all recommended actions from research, has proper error handling, concurrency control, and timeout.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify CI pipeline and set up GitHub deployment</name>
  <action>
    User reviews the automated pipeline configuration and sets up GitHub repository for deployment.
  </action>
  <what-built>
    Complete GitHub Actions CI/CD pipeline for automated daily data refresh and widget deployment:
    - CI helper script (scripts/ci-setup-tokens.mjs) for token management
    - GitHub Actions workflow (.github/workflows/daily-refresh.yml) with schedule + manual trigger
    - GitHub Pages landing page (dist/widgets/index.html)
    - Updated .gitignore to track activity data and stats
    - New npm scripts (fetch, process) for CI pipeline steps
  </what-built>
  <how-to-verify>
    1. Review the workflow file: `cat .github/workflows/daily-refresh.yml`
       - Verify it has schedule (cron), workflow_dispatch, proper permissions
       - Verify steps: checkout, setup-node, npm ci, setup-tokens, fetch, process, build, commit, deploy
       - Verify error handling (continue-on-error on fetch)

    2. Review the CI token script: `cat scripts/ci-setup-tokens.mjs`
       - Verify it reads STRAVA_REFRESH_TOKEN and writes tokens.json
       - Verify it skips if tokens.json already exists

    3. To test the full pipeline on GitHub:
       a. Create a PRIVATE GitHub repository
       b. Add secrets in repo Settings -> Secrets and variables -> Actions:
          - STRAVA_CLIENT_ID (from https://www.strava.com/settings/api)
          - STRAVA_CLIENT_SECRET (from https://www.strava.com/settings/api)
          - STRAVA_REFRESH_TOKEN (from your local data/tokens.json, copy the refresh_token value)
       c. Enable GitHub Pages: Settings -> Pages -> Source -> "GitHub Actions"
       d. Push code: `git remote add origin <url> && git push -u origin main`
       e. Go to Actions tab -> "Daily Widget Refresh" -> "Run workflow" -> click "Run workflow"
       f. Watch the workflow run -- all steps should pass
       g. After deployment, visit your GitHub Pages URL to see the widget landing page

    NOTE on token rotation: After the first successful CI run, the committed data/tokens.json
    will contain the current refresh token. The CI setup script detects this and skips bootstrapping.
    The STRAVA_REFRESH_TOKEN secret is only needed if tokens.json is missing from the repo.
  </how-to-verify>
  <verify>User confirms workflow runs successfully or reports issues.</verify>
  <done>GitHub Actions pipeline verified working: daily schedule active, manual trigger functional, widgets deployed to GitHub Pages.</done>
  <resume-signal>Type "approved" or describe any issues</resume-signal>
</task>

</tasks>

<verification>
Phase 4 success criteria check:
1. GitHub Actions workflow runs daily -- verified by cron schedule in daily-refresh.yml
2. Workflow processes stats and regenerates widgets -- verified by compute-all-stats and build-widgets steps
3. Widgets committed and deployed to GitHub Pages -- verified by git-auto-commit and gh-pages actions
4. Error handling with notifications -- verified by continue-on-error on fetch + GitHub's built-in failure notifications
5. Manual trigger capability -- verified by workflow_dispatch trigger
</verification>

<success_criteria>
- .github/workflows/daily-refresh.yml exists with schedule + manual trigger
- Workflow contains all pipeline steps: setup, fetch, process, build, commit, deploy
- scripts/ci-setup-tokens.mjs creates tokens.json from environment variable
- .gitignore tracks data/activities/ and data/stats/ (not tokens.json)
- dist/widgets/index.html serves as GitHub Pages landing page
- No secrets hardcoded in any committed file
- Workflow uses recommended actions: checkout@v6, setup-node@v6, gh-pages@v4, git-auto-commit@v7
</success_criteria>

<output>
After completion, create `.planning/phases/04-automation-deployment/04-01-SUMMARY.md`
</output>

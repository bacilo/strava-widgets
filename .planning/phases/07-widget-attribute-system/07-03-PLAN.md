---
phase: 07-widget-attribute-system
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/widgets/streak-widget/index.ts
  - src/widgets/streak-widget/chart-config.ts
  - src/widgets/geo-stats-widget/index.ts
  - src/widgets/geo-stats-widget/csv-exporter.ts
  - test/widgets/test-widgets.html
autonomous: true

must_haves:
  truths:
    - "Streak widget renders when used as <strava-streak-widget> custom element with data-attributes"
    - "Geo-stats widget renders when used as <strava-geo-stats> custom element with data-attributes"
    - "Both widgets support data-theme for dark/light/auto mode switching"
    - "Both widgets respond to container size changes"
    - "Test page demonstrates all four widgets using HTML-only attribute configuration"
  artifacts:
    - path: "src/widgets/streak-widget/index.ts"
      provides: "Streak widget as Custom Element with attribute-driven config"
      contains: "customElements.define"
    - path: "src/widgets/geo-stats-widget/index.ts"
      provides: "Geo-stats widget as Custom Element with attribute-driven config"
      contains: "customElements.define"
    - path: "test/widgets/test-widgets.html"
      provides: "Test page showing all 4 widgets with HTML-only attribute config"
      contains: "strava-stats-card"
  key_links:
    - from: "src/widgets/streak-widget/index.ts"
      to: "src/widgets/shared/widget-base.ts"
      via: "extends WidgetBase"
      pattern: "extends WidgetBase"
    - from: "src/widgets/geo-stats-widget/index.ts"
      to: "src/widgets/shared/widget-base.ts"
      via: "extends WidgetBase"
      pattern: "extends WidgetBase"
    - from: "test/widgets/test-widgets.html"
      to: "dist/widgets/*.iife.js"
      via: "script src references"
      pattern: "script.*iife\\.js"
---

<objective>
Migrate the streak-widget and geo-stats-widget to Custom Elements, then create a comprehensive test page demonstrating all four widgets using HTML-only attribute configuration. This completes the Phase 7 widget migration.

Purpose: These final two widgets complete the attribute system rollout. The test page serves as both verification and documentation -- proving that all widgets work in HTML-only environments (CMSes, Jekyll) without JavaScript initialization code.

Output: Two migrated widgets and a test page showing all four widgets configured purely via HTML attributes.
</objective>

<execution_context>
@/Users/pedf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pedf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-widget-attribute-system/07-RESEARCH.md
@.planning/phases/07-widget-attribute-system/07-01-SUMMARY.md
@src/widgets/streak-widget/index.ts
@src/widgets/streak-widget/chart-config.ts
@src/widgets/geo-stats-widget/index.ts
@src/widgets/geo-stats-widget/csv-exporter.ts
@src/widgets/shared/widget-base.ts
@src/widgets/shared/attribute-parser.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate streak-widget and geo-stats-widget to Custom Elements</name>
  <files>
    src/widgets/streak-widget/index.ts
    src/widgets/streak-widget/chart-config.ts
    src/widgets/geo-stats-widget/index.ts
    src/widgets/geo-stats-widget/csv-exporter.ts
  </files>
  <action>
Rewrite both widgets to extend the new WidgetBase:

**streak-widget/index.ts:**

1. Class: `class StreakWidgetElement extends WidgetBase`
2. Static observedAttributes: Extend base with:
   - `data-url-secondary` (time-of-day data URL)
   - `data-show-chart` (boolean, whether to show radar chart, default true)
3. Remove old constructor(containerId, config).
4. connectedCallback: Call super.connectedCallback().
5. render(data): Adapt to read from attributes:
   - Title: `this.getAttribute('data-title') || 'Streak & Patterns'`
   - Show title: `this.getAttribute('data-show-title') !== 'false'`
   - Show chart: `this.getAttribute('data-show-chart') !== 'false'`
   - Accent color for radar chart: `this.getAttribute('data-accent') || '#fc4c02'`
6. Data fetching: Override fetchDataAndRender for dual sources (streaks + time-of-day patterns).
7. chart-config.ts: Update createTimeOfDayRadarChart to accept theme parameter:
   - Dark mode: grid lines rgba(255,255,255,0.15), point label color #ccc, tick color #999
   - Light mode: existing colors
8. Dark mode styles in STREAK_WIDGET_STYLES:
   - .streak-widget box-shadow adapts (darker shadow in dark mode)
   - .streak-item background: rgba(255, 107, 53, 0.1) in dark mode
   - .streak-label, .streak-detail colors lighten in dark mode
   - border-top color adapts
9. Responsive styles:
   - compact: streak-grid single column, smaller fonts
   - medium: streak-grid 2 columns
   - large: auto-fit (current)
10. Register: `WidgetBase.register('strava-streak-widget', StreakWidgetElement);`
11. Backwards-compatible: Keep `window.StreakWidget = { init(containerId, config) {...} }`

**geo-stats-widget/index.ts:**

1. Class: `class GeoStatsWidgetElement extends WidgetBase`
2. Static observedAttributes: Extend base with:
   - `data-url-secondary` (cities data URL)
   - `data-url-metadata` (metadata URL, replaces config.options.metadataUrl)
   - `data-show-export` (boolean, show CSV export buttons, default true)
   - `data-max-rows` (number, max table rows to display, default all)
3. Remove old constructor(containerId, config).
4. connectedCallback: Call super.connectedCallback().
5. render(data): Adapt to read from attributes:
   - Title: `this.getAttribute('data-title') || 'Running by Location'`
   - Show title: `this.getAttribute('data-show-title') !== 'false'`
   - Show export: `this.getAttribute('data-show-export') !== 'false'`
   - Max rows: `parseNumber(this.getAttribute('data-max-rows'), Infinity, 1)` -- slice data if finite
6. Data fetching: Override fetchDataAndRender for triple data sources (countries, cities, metadata) using Promise.all (existing pattern).
7. csv-exporter.ts: No changes needed (already receives data as parameters, not reading config).
8. Dark mode styles in GEO_STATS_STYLES:
   - .geo-stats-card box-shadow adapts
   - .geo-metadata background: rgba(255, 107, 53, 0.1) in dark mode
   - .geo-table th border color, .geo-table td border color adapt
   - .export-btn dark variant (dark border, light text, dark bg)
   - .rank-cell color adapts
9. Responsive styles:
   - compact: table font-size smaller, hide less-important columns (cities count in countries table) via display:none
   - medium/large: full table (current)
10. Register: `WidgetBase.register('strava-geo-stats', GeoStatsWidgetElement);`
11. Backwards-compatible: Keep `window.GeoStatsWidget = { init(containerId, config) {...} }`

**HTML usage after migration:**
```html
<strava-streak-widget
  data-url="/data/stats/streaks.json"
  data-url-secondary="/data/stats/time-of-day.json"
  data-title="My Running Streaks"
  data-theme="auto"
></strava-streak-widget>

<strava-geo-stats
  data-url="/data/geo/countries.json"
  data-url-secondary="/data/geo/cities.json"
  data-url-metadata="/data/geo/geo-stats-metadata.json"
  data-theme="dark"
  data-max-rows="10"
></strava-geo-stats>
```
  </action>
  <verify>
Run `npx tsc --noEmit` -- ALL widget files should now compile without errors (all four widgets migrated). Run `npm run build-widgets` -- all four .iife.js files should build successfully. Verify each built file contains `customElements.define`.
  </verify>
  <done>
Both streak-widget and geo-stats-widget work as Custom Elements. All four widgets in the library are now attribute-driven. TypeScript compiles cleanly across entire project. All widget builds succeed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create test page demonstrating HTML-only widget configuration</name>
  <files>
    test/widgets/test-widgets.html
  </files>
  <action>
Create (or update if exists) a comprehensive test page at test/widgets/test-widgets.html that demonstrates ALL four widgets using ONLY HTML attributes (no JavaScript configuration). This page is the definitive proof that the attribute system works in HTML-only environments.

The page should:

1. **Include all four widget scripts** via script tags pointing to dist/widgets/:
   ```html
   <script src="../../dist/widgets/stats-card.iife.js"></script>
   <script src="../../dist/widgets/comparison-chart.iife.js"></script>
   <script src="../../dist/widgets/streak-widget.iife.js"></script>
   <script src="../../dist/widgets/geo-stats-widget.iife.js"></script>
   ```

2. **Show each widget in light mode** (default):
   ```html
   <strava-stats-card
     data-url="../../dist/widgets/data/stats/all-time-totals.json"
     data-url-secondary="../../dist/widgets/data/stats/year-over-year.json"
     data-title="All-Time Running Stats"
   ></strava-stats-card>
   ```

   Similar for comparison-chart, streak-widget, geo-stats.

3. **Show a dark mode section** with the same widgets using `data-theme="dark"`:
   ```html
   <div style="background: #121212; padding: 20px;">
     <strava-stats-card
       data-url="../../dist/widgets/data/stats/all-time-totals.json"
       data-theme="dark"
       data-title="Dark Mode Stats"
     ></strava-stats-card>
   </div>
   ```

4. **Show customization examples**:
   - Widget with custom accent color: `data-accent="#22c55e"`
   - Widget with custom width: `data-width="500px"` and `data-max-width="500px"`
   - Widget with custom title: `data-title="Custom Title Here"`
   - Chart with custom colors: `data-chart-colors='["#8b5cf6","#f59e0b","#06b6d4"]'`
   - Geo-stats with max rows: `data-max-rows="5"`

5. **Show responsive behavior**: Include a widget inside a narrow container (300px width) to demonstrate compact layout, and one inside a wide container (900px) for large layout.

6. **Page structure**: Simple HTML with minimal inline styles for layout (flexbox sections). Include section headings describing what each demo shows. No external CSS frameworks.

7. **Instructions at top**: Brief paragraph explaining this page demonstrates HTML-only widget configuration -- no JavaScript init calls needed.

Build the widgets first if not already built: the test page requires `npm run build-widgets` to have been run.
  </action>
  <verify>
Run `npm run build-widgets` to ensure all four widgets build. Open test/widgets/test-widgets.html in a browser (or verify via `ls test/widgets/test-widgets.html` that it exists). Verify the HTML file references all four widget custom elements and uses only data-attributes for configuration (no JavaScript init calls in the page).
  </verify>
  <done>
Test page exists at test/widgets/test-widgets.html. It demonstrates all four widgets (stats-card, comparison-chart, streak-widget, geo-stats) using HTML-only attribute configuration. Shows light mode, dark mode, custom colors, custom sizes, responsive behavior, and max-rows limiting. No JavaScript widget initialization code in the page -- pure HTML custom elements.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors across entire project
- `npm run build-widgets` produces all four .iife.js files:
  - dist/widgets/stats-card.iife.js
  - dist/widgets/comparison-chart.iife.js
  - dist/widgets/streak-widget.iife.js
  - dist/widgets/geo-stats-widget.iife.js
- Each built file contains `customElements.define` call
- test/widgets/test-widgets.html exists and uses only data-attributes (no JS init)
- All widgets support: data-url, data-theme, data-title, data-width, data-accent
- Phase 7 success criteria met:
  1. Widgets configurable via HTML data-attributes (WCUST-01)
  2. Dark/light mode via data-theme attribute (WCUST-02)
  3. Widgets auto-adapt to container size (WCUST-03)
  4. All existing widgets support new system (WCUST-04)
  5. Works in HTML-only environments (WCUST-05 implied by test page)
</verification>

<success_criteria>
- All four widgets are Custom Elements registered with customElements.define
- All four widgets accept configuration via HTML data-attributes
- Dark mode works via data-theme="dark", light via data-theme="light", auto-detection when omitted or data-theme="auto"
- Widgets are responsive to container size (compact/medium/large)
- Test page demonstrates complete HTML-only usage
- Backwards-compatible JavaScript .init() API preserved for all widgets
- TypeScript compiles cleanly, all widget builds succeed
</success_criteria>

<output>
After completion, create `.planning/phases/07-widget-attribute-system/07-03-SUMMARY.md`
</output>

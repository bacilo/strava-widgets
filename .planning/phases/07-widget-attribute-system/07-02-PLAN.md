---
phase: 07-widget-attribute-system
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/widgets/stats-card/index.ts
  - src/widgets/comparison-chart/index.ts
  - src/widgets/comparison-chart/chart-config.ts
autonomous: true

must_haves:
  truths:
    - "Stats card widget renders when used as <strava-stats-card> custom element with data-attributes"
    - "Comparison chart widget renders when used as <strava-comparison-chart> custom element with data-attributes"
    - "Both widgets support data-theme for dark/light/auto mode switching"
    - "Both widgets respond to container size changes"
    - "Chart.js colors are configurable via data-chart-colors attribute"
  artifacts:
    - path: "src/widgets/stats-card/index.ts"
      provides: "Stats card as Custom Element with attribute-driven config"
      contains: "customElements.define"
    - path: "src/widgets/comparison-chart/index.ts"
      provides: "Comparison chart as Custom Element with attribute-driven config"
      contains: "customElements.define"
  key_links:
    - from: "src/widgets/stats-card/index.ts"
      to: "src/widgets/shared/widget-base.ts"
      via: "extends WidgetBase"
      pattern: "extends WidgetBase"
    - from: "src/widgets/stats-card/index.ts"
      to: "src/widgets/shared/attribute-parser.ts"
      via: "import attribute parsing"
      pattern: "import.*attribute-parser"
    - from: "src/widgets/comparison-chart/index.ts"
      to: "src/widgets/shared/widget-base.ts"
      via: "extends WidgetBase"
      pattern: "extends WidgetBase"
---

<objective>
Migrate the stats-card and comparison-chart widgets from JavaScript-config initialization to HTML attribute-driven Custom Elements. After this plan, both widgets can be used as `<strava-stats-card data-url="...">` and `<strava-comparison-chart data-url="...">` without any JavaScript configuration.

Purpose: These are the two widgets that use Chart.js for visualization. Migrating them validates that the attribute system works correctly with Chart.js rendering, responsive Chart.js canvases in Shadow DOM, and dark/light theme switching for chart colors.

Output: Two fully functional Custom Element widgets with attribute-driven configuration and custom element registration.
</objective>

<execution_context>
@/Users/pedf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pedf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-widget-attribute-system/07-RESEARCH.md
@.planning/phases/07-widget-attribute-system/07-01-SUMMARY.md
@src/widgets/stats-card/index.ts
@src/widgets/comparison-chart/index.ts
@src/widgets/comparison-chart/chart-config.ts
@src/widgets/shared/widget-base.ts
@src/widgets/shared/attribute-parser.ts
@src/widgets/shared/theme-manager.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate stats-card to Custom Element with attribute support</name>
  <files>
    src/widgets/stats-card/index.ts
  </files>
  <action>
Rewrite StatsCardWidget to extend the new WidgetBase (which extends HTMLElement):

1. **Class definition**: `class StatsCardWidget extends WidgetBase` -- no more generic type parameter.

2. **Static observedAttributes**: Extend base class attributes with stats-card-specific ones:
   - `data-url-secondary` (year-over-year data URL)
   - `data-show-yoy` (boolean, whether to show year-over-year section, default true)

3. **Remove old constructor**: No more (containerId, config) constructor. The Custom Element lifecycle handles everything.

4. **Override connectedCallback**: Call `super.connectedCallback()`. The base class handles Shadow DOM, theme, responsive, loading state, and data fetching.

5. **Implement render(data)**: Adapt existing render logic to read configuration from attributes instead of this.config:
   - Title: `this.getAttribute('data-title') || 'Running Stats'`
   - Show title: Use `parseBoolean(this, 'data-show-title', true)` (default true, presence means true, but default when absent is true -- use `!this.hasAttribute('data-hide-title')` pattern or check if data-show-title is explicitly 'false')
   - Actually, simpler approach: if `data-title` attribute exists, show title with that value. If `data-show-title` is absent, default to showing. If `data-show-title="false"` explicitly set, hide. Use: `const showTitle = this.getAttribute('data-show-title') !== 'false';`
   - Colors: Read from data-bg, data-text-color, data-accent via base class theme system (already applied via CSS custom properties)
   - Year-over-year: Fetch from `this.getAttribute('data-url-secondary')` if present

6. **Data fetching**: Override the base class's fetchDataAndRender to handle dual data sources:
   - Primary: `data-url` attribute -> all-time-totals.json
   - Secondary: `data-url-secondary` attribute -> year-over-year.json
   - Use Promise.all for parallel fetch (existing pattern from geo-stats)

7. **Register Custom Element**: At bottom of file:
   ```typescript
   WidgetBase.register('strava-stats-card', StatsCardWidget);
   ```

8. **Keep backwards-compatible init function**: Maintain the `window.StatsCard = { init(containerId, config) {...} }` pattern that creates the element programmatically, sets attributes from config, and appends to the container. This preserves the existing JavaScript API for users who already use it.

9. **Dark mode styles**: Update STATS_CARD_STYLES to include dark mode variants:
   - Dark: .stats-card background uses var(--widget-bg), box-shadow adapts
   - Dark: .stat-item background uses rgba(255, 107, 53, 0.1) instead of rgba(252, 76, 2, 0.05)
   - Dark: .yoy-item background uses #2a2a2a instead of #f8f8f8
   - Dark: borders use #333 instead of #eee
   - Use :host([data-theme="dark"]) parent selectors in styles

10. **Responsive**: The base class sets data-size attribute. Add styles for:
    - compact (<400px): stats-grid single column, smaller font sizes
    - medium (400-699px): stats-grid 2 columns
    - large (>=700px): stats-grid auto-fit (current behavior)

**HTML usage after migration:**
```html
<strava-stats-card
  data-url="/data/stats/all-time-totals.json"
  data-url-secondary="/data/stats/year-over-year.json"
  data-title="My Running Stats"
  data-theme="auto"
></strava-stats-card>
```
  </action>
  <verify>
Run `npx tsc --noEmit` -- stats-card should compile without errors. Run `npm run build-widgets` -- stats-card.iife.js should build successfully. Check that the built file contains `customElements.define`.
  </verify>
  <done>
Stats card widget works as `<strava-stats-card>` Custom Element. Reads data-url, data-url-secondary, data-title, data-theme, data-accent, data-width from HTML attributes. Supports dark/light/auto theme. Responsive layout with data-size breakpoints. Backwards-compatible StatsCard.init() still works.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate comparison-chart to Custom Element with attribute support</name>
  <files>
    src/widgets/comparison-chart/index.ts
    src/widgets/comparison-chart/chart-config.ts
  </files>
  <action>
Rewrite ComparisonChartWidget to extend the new WidgetBase:

1. **Class definition**: `class ComparisonChartWidget extends WidgetBase`

2. **Static observedAttributes**: Extend base with chart-specific ones:
   - `data-url-secondary` (seasonal trends data URL)
   - `data-chart-colors` (JSON array of color strings for chart datasets)
   - `data-show-legend` (boolean, default true)

3. **Remove old constructor**: No more (containerId, config).

4. **Override connectedCallback**: Call super.connectedCallback().

5. **Implement render(data)**: Adapt to read from attributes:
   - Chart colors: `parseJSON(this.getAttribute('data-chart-colors'), ['#3b82f6', '#ef4444', '#22c55e'])` from attribute-parser
   - Show legend: `this.getAttribute('data-show-legend') !== 'false'`
   - Title: `this.getAttribute('data-title') || 'Year-over-Year Comparison'`

6. **Chart.js theme integration** (chart-config.ts changes):
   - Update createYearOverYearChart and createSeasonalTrendsChart to accept a `theme: 'light' | 'dark'` parameter
   - Dark mode: grid lines use rgba(255,255,255,0.1), tick colors use #999, legend text uses #ccc
   - Light mode: existing colors (unchanged)
   - Chart text colors should use the theme parameter, not hardcoded values

7. **Data fetching**: Override fetchDataAndRender for dual sources (year-over-year + seasonal trends).

8. **Register**: `WidgetBase.register('strava-comparison-chart', ComparisonChartWidget);`

9. **Backwards-compatible init**: Keep `window.ComparisonChart = { init(containerId, config) {...} }` that creates element, sets attributes from config, appends.

10. **Responsive chart behavior**:
    - The base class Chart.js responsive:true already handles canvas resizing
    - For compact size: reduce chart padding, hide legend if too small, reduce font sizes
    - Use CSS container query in styles: `.chart-section` height adjusts based on host data-size

11. **Dark mode styles**: Update COMPARISON_CHART_STYLES:
    - Container background adapts to theme
    - Canvas container inherits theme colors

**HTML usage after migration:**
```html
<strava-comparison-chart
  data-url="/data/stats/year-over-year.json"
  data-url-secondary="/data/stats/seasonal-trends.json"
  data-chart-colors='["#3b82f6", "#ef4444", "#22c55e"]'
  data-theme="dark"
  data-show-legend
></strava-comparison-chart>
```
  </action>
  <verify>
Run `npx tsc --noEmit` -- comparison-chart should compile without errors. Run `npm run build-widgets` -- comparison-chart.iife.js should build successfully. Check built file contains `customElements.define`.
  </verify>
  <done>
Comparison chart widget works as `<strava-comparison-chart>` Custom Element. Chart.js colors adapt to dark/light theme. Chart colors configurable via data-chart-colors JSON attribute. Responsive chart sizing works with container resize. Backwards-compatible ComparisonChart.init() still works.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes (may still have errors in streak-widget and geo-stats-widget -- those are migrated in Plan 03)
- `npm run build-widgets` produces stats-card.iife.js and comparison-chart.iife.js
- Both built files contain customElements.define calls
- Both widgets support data-url, data-theme, data-title, data-width, data-accent attributes
- Stats card supports data-url-secondary for year-over-year data
- Comparison chart supports data-chart-colors JSON attribute
- Both include dark mode CSS variant styles
</verification>

<success_criteria>
- Stats card renders as <strava-stats-card> Custom Element with attribute configuration
- Comparison chart renders as <strava-comparison-chart> Custom Element with attribute configuration
- Both support dark/light/auto theme via data-theme attribute
- Both respond to container size changes
- Both maintain backwards-compatible JavaScript init() API
- Chart.js chart colors adapt to theme
</success_criteria>

<output>
After completion, create `.planning/phases/07-widget-attribute-system/07-02-SUMMARY.md`
</output>

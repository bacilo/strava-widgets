---
phase: 06-geographic-statistics
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/widgets/geo-stats-widget/index.ts
  - src/widgets/geo-stats-widget/csv-exporter.ts
  - scripts/build-widgets.mjs
  - public/test-widgets.html
autonomous: false
must_haves:
  truths:
    - "User can see total distance and run count per country, ranked by distance"
    - "User can see total distance and run count per city, ranked by distance"
    - "User can export geographic statistics as a CSV file"
    - "Statistics display coverage metadata showing how many activities included GPS data"
  artifacts:
    - path: "src/widgets/geo-stats-widget/index.ts"
      provides: "Geographic statistics widget with country and city tables"
      min_lines: 150
    - path: "src/widgets/geo-stats-widget/csv-exporter.ts"
      provides: "CSV export utility with UTF-8 BOM for Excel compatibility"
      exports: ["exportCountriesToCSV", "exportCitiesToCSV"]
    - path: "scripts/build-widgets.mjs"
      provides: "Updated widget build script including geo-stats-widget"
      contains: "geo-stats-widget"
    - path: "public/test-widgets.html"
      provides: "Test page including geo-stats widget"
      contains: "geo-stats-widget"
  key_links:
    - from: "src/widgets/geo-stats-widget/index.ts"
      to: "data/geo/countries.json"
      via: "fetch in fetchAllData using config.dataUrl"
      pattern: "fetchData.*countries"
    - from: "src/widgets/geo-stats-widget/index.ts"
      to: "data/geo/cities.json"
      via: "fetch in fetchAllData using config.options.secondaryDataUrl"
      pattern: "fetchData.*secondaryDataUrl"
    - from: "src/widgets/geo-stats-widget/index.ts"
      to: "data/geo/geo-metadata.json"
      via: "fetch in fetchAllData using config.options.metadataUrl"
      pattern: "fetchData.*metadataUrl"
    - from: "src/widgets/geo-stats-widget/index.ts"
      to: "src/widgets/geo-stats-widget/csv-exporter.ts"
      via: "import exportCountriesToCSV, exportCitiesToCSV"
      pattern: "import.*csv-exporter"
    - from: "scripts/build-widgets.mjs"
      to: "src/widgets/geo-stats-widget/index.ts"
      via: "widget entry in build config"
      pattern: "geo-stats-widget"
---

<objective>
Build an embeddable geographic statistics widget that displays country and city ranking tables with CSV export and coverage metadata.

Purpose: This is the user-facing deliverable for Phase 6. Users need to see their running statistics aggregated by geography (GSTAT-01, GSTAT-02) and export the data (GSTAT-03). The widget consumes the distance-enriched JSON files produced by Plan 01.

Output: Working geo-stats-widget.iife.js bundle, registered in build pipeline, testable on test-widgets.html.
</objective>

<execution_context>
@/Users/pedf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pedf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-geographic-statistics/06-01-SUMMARY.md
@.planning/phases/06-geographic-statistics/06-RESEARCH.md
@src/widgets/shared/widget-base.ts
@src/widgets/stats-card/index.ts
@src/types/widget-config.types.ts
@scripts/build-widgets.mjs
@public/test-widgets.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create geo-stats widget with CSV export</name>
  <files>
    src/widgets/geo-stats-widget/index.ts
    src/widgets/geo-stats-widget/csv-exporter.ts
  </files>
  <action>
Create two files for the geo-stats widget:

**File 1: `src/widgets/geo-stats-widget/csv-exporter.ts`**

Export two functions:

`exportCountriesToCSV(countries: CountryStats[])`:
- Headers: Rank, Country, ISO Code, Distance (km), Runs, Cities
- Rows: map countries with idx+1 as rank, countryName, countryIso2, totalDistanceKm, activityCount, cities.length
- Wrap all field values in double quotes for CSV safety (handles commas in names like "Montemor-o-Novo")
- Prepend UTF-8 BOM (`\uFEFF`) before CSV content for Excel compatibility
- Create Blob with type `text/csv;charset=utf-8;`
- Create temporary `<a>` element with download attribute, filename: `running-stats-countries-YYYY-MM-DD.csv`
- Click to trigger download, then call `URL.revokeObjectURL(url)` to prevent memory leaks
- Note: Append `<a>` to `document.body` (not shadowRoot) for cross-browser download compatibility, then remove it

`exportCitiesToCSV(cities: CityStats[])`:
- Headers: Rank, City, Country, ISO Code, Distance (km), Runs
- Rows: map cities with idx+1 as rank, cityName, countryName, countryIso2, totalDistanceKm, activityCount
- Same BOM, quoting, Blob, download, cleanup pattern as countries
- Filename: `running-stats-cities-YYYY-MM-DD.csv`

Define the type interfaces at the top of this file (or share via import):
```typescript
interface CountryStats {
  countryName: string;
  countryIso2: string;
  activityCount: number;
  totalDistanceKm: number;
  cities: string[];
}

interface CityStats {
  cityName: string;
  countryName: string;
  countryIso2: string;
  activityCount: number;
  totalDistanceKm: number;
}
```

**File 2: `src/widgets/geo-stats-widget/index.ts`**

Create a GeoStatsWidget class extending WidgetBase following existing patterns (see stats-card/index.ts):

1. **Imports**: Import WidgetBase from `../shared/widget-base.js`, WidgetConfig from `../../types/widget-config.types.js`, and csv-exporter functions.

2. **Interfaces** (at top of file):
```typescript
interface GeoMetadata {
  generatedAt: string;
  totalActivities: number;
  geocodedActivities: number;
  coveragePercent: number;
  cacheSize: number;
  totalDistanceKm: number;
}
```
Plus CountryStats and CityStats (same as csv-exporter, or import from csv-exporter).

3. **Styles** (const `GEO_STATS_STYLES` string):
- `.geo-stats-card`: background var(--widget-bg), border-radius 12px, box-shadow, padding 24px (match stats-card pattern)
- `.card-title`: font-size 20px, font-weight 600, margin 0 0 20px 0 (match stats-card)
- `.geo-metadata`: font-size 13px, color #888, margin-bottom 20px, padding 8px 12px, background rgba(252,76,2,0.05), border-radius 6px
- `.section-title`: font-size 16px, font-weight 600, margin 24px 0 12px 0, color var(--widget-text), display flex, justify-content space-between, align-items center
- `.export-btn`: font-size 12px, padding 4px 12px, border 1px solid #ddd, border-radius 4px, background white, color #666, cursor pointer, font-weight 400. On hover: background #f5f5f5, border-color #bbb
- `.geo-table`: width 100%, border-collapse collapse, font-size 14px
- `.geo-table th`: text-align left, padding 8px 12px, border-bottom 2px solid #eee, color #666, font-weight 600, font-size 12px, text-transform uppercase, letter-spacing 0.5px
- `.geo-table td`: padding 8px 12px, border-bottom 1px solid #f0f0f0
- `.geo-table tr:last-child td`: border-bottom none
- `.rank-cell`: color #999, font-weight 500, width 40px
- `.number-cell`: text-align right, font-variant-numeric tabular-nums
- `.country-cell, .city-cell`: font-weight 500

4. **Constructor**: Call `super(containerId, config, true)` (skipAutoFetch=true, because we need to fetch multiple URLs manually — same pattern as StatsCard).

5. **fetchAllData() method**: Fetch three JSON files in parallel using Promise.all:
   - `this.fetchData<CountryStats[]>(this.config.dataUrl)` — countries
   - `this.fetchData<CityStats[]>(this.config.options?.secondaryDataUrl)` — cities
   - `this.fetchData<GeoMetadata>(this.config.options?.metadataUrl)` — metadata
   Guard: if secondaryDataUrl or metadataUrl missing, set cities=[] or metadata=null and log warning.

6. **render(data) method** — called with countries data. Since we use manual fetch pattern (like StatsCard), render will receive countries. Store cities and metadata on instance.

7. **Rendering logic** (build DOM in render method):
   a. Inject GEO_STATS_STYLES via `<style>` element
   b. Create `.geo-stats-card` container div
   c. If showTitle !== false, add `<h2 class="card-title">` with customTitle or "Running by Location"
   d. If metadata exists, render coverage line: "Based on {geocodedActivities.toLocaleString()} of {totalActivities.toLocaleString()} activities ({coveragePercent}% with GPS data) - {totalDistanceKm.toLocaleString()} km total"
   e. Render **Countries section**:
      - Section title "Countries" with "Export CSV" button (call exportCountriesToCSV on click)
      - `<table class="geo-table">` with thead: Rank, Country, Distance (km), Runs, Cities
      - tbody: for each country, row with rank (idx+1), countryName, totalDistanceKm.toLocaleString(), activityCount.toLocaleString(), cities.length
   f. Render **Cities section**:
      - Section title "Cities" with "Export CSV" button (call exportCitiesToCSV on click)
      - `<table class="geo-table">` with thead: Rank, City, Country, Distance (km), Runs
      - tbody: for each city, row with rank (idx+1), `${cityName} (${countryIso2})` in city cell OR cityName in one column and countryName in another (use separate columns for clarity), totalDistanceKm.toLocaleString(), activityCount.toLocaleString()

8. **Global init** (at bottom, following StatsCard pattern exactly):
```typescript
const GeoStatsWidget = {
  async init(containerId: string, config: WidgetConfig): Promise<void> {
    const widget = new GeoStatsWidgetClass(containerId, config);
    try {
      // Fetch all three data sources
      const [countries, cities, metadata] = await Promise.all([
        widget['fetchData'](config.dataUrl),
        config.options?.secondaryDataUrl
          ? widget['fetchData'](config.options.secondaryDataUrl)
          : Promise.resolve([]),
        config.options?.metadataUrl
          ? widget['fetchData'](config.options.metadataUrl)
          : Promise.resolve(null)
      ]);

      // Store secondary data on widget instance
      widget['citiesData'] = cities;
      widget['metadataData'] = metadata;

      // Clear loading
      if (widget['shadowRoot']) {
        const loadingEl = widget['shadowRoot'].querySelector('.widget-loading');
        if (loadingEl) loadingEl.remove();
      }

      widget['render'](countries);
    } catch (error) {
      console.error('GeoStatsWidget: Failed to load data', error);
      widget['showError']();
    }
  }
};

(window as any).GeoStatsWidget = GeoStatsWidget;
```

Key conventions to follow from existing widgets:
- Use `document.createElement` for all DOM creation (no innerHTML)
- Use `.toLocaleString()` for number formatting
- Use `var(--widget-text)`, `var(--widget-bg)`, `var(--widget-accent)` CSS custom properties
- Match the visual style of stats-card (border-radius 12px, box-shadow, padding 24px, accent color #fc4c02)
  </action>
  <verify>
Run `npm run build` to confirm TypeScript compiles without errors. Verify the two new files exist:
- `src/widgets/geo-stats-widget/index.ts` (should be 150+ lines)
- `src/widgets/geo-stats-widget/csv-exporter.ts` (should be 40+ lines)
  </verify>
  <done>Both files compile clean. Widget class extends WidgetBase, renders country and city tables with distance and run count, displays coverage metadata, and has CSV export buttons for both tables.</done>
</task>

<task type="auto">
  <name>Task 2: Register widget in build pipeline and test page</name>
  <files>
    scripts/build-widgets.mjs
    public/test-widgets.html
  </files>
  <action>
**File 1: `scripts/build-widgets.mjs`**

Add a new entry to the `widgets` array:
```javascript
{
  name: 'geo-stats-widget',
  entry: resolve(__dirname, '../src/widgets/geo-stats-widget/index.ts'),
  globalName: 'GeoStatsWidget'
}
```

Add it after the existing streak-widget entry.

**File 2: `public/test-widgets.html`**

Add a new widget section BEFORE the dark theme section (before "Widget with custom dark theme" comment). Add:

1. HTML section:
```html
<!-- Widget 5: Geo Stats Widget (Phase 6) -->
<div class="widget-section">
  <h2 class="section-header">5. Geographic Statistics</h2>
  <p class="section-description">Country and city running rankings with distance, run count, and CSV export (Phase 6 widget)</p>
  <div class="widget-container">
    <div id="geo-stats-widget"></div>
  </div>
</div>
```

2. Update the numbering of subsequent sections (dark theme becomes 6, Jekyll becomes unchanged since it doesn't have a number in heading).

3. Add script tag to load the widget bundle (after the streak-widget script):
```html
<script src="../dist/widgets/geo-stats-widget.iife.js"></script>
```

4. Add initialization call (after streak widget init, before dark theme init):
```javascript
// Widget 5: Geo Stats Widget
window.GeoStatsWidget.init('geo-stats-widget', {
  dataUrl: '../data/geo/countries.json',
  options: {
    showTitle: true,
    customTitle: 'Running by Location',
    secondaryDataUrl: '../data/geo/cities.json',
    metadataUrl: '../data/geo/geo-metadata.json'
  }
});
```
  </action>
  <verify>
Run `npm run build-widgets` to confirm all 4 widgets build successfully (stats-card, comparison-chart, streak-widget, geo-stats-widget). Verify `dist/widgets/geo-stats-widget.iife.js` exists. Run `npx serve . -p 4173` and open `http://localhost:4173/public/test-widgets.html` to visually verify the widget renders.
  </verify>
  <done>geo-stats-widget.iife.js bundle builds successfully. Widget appears on test page showing country and city tables with distance data, export buttons, and coverage metadata.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify geographic statistics widget visually</name>
  <action>Human verification of the complete geo-stats widget rendering, data accuracy, CSV export, and Shadow DOM isolation.</action>
  <what-built>Complete geographic statistics widget displaying country and city rankings with distance data, CSV export, and coverage metadata. Widget follows existing Shadow DOM pattern and is bundled as IIFE.</what-built>
  <how-to-verify>
    1. Start local server: `npx serve . -p 4173` from project root
    2. Open http://localhost:4173/public/test-widgets.html in browser
    3. Scroll to "Geographic Statistics" widget section
    4. Verify COUNTRIES TABLE:
       - Shows ranked list of countries with columns: Rank, Country, Distance (km), Runs, Cities
       - Denmark should be #1 (highest distance)
       - Numbers are formatted with commas (e.g., "1,322" not "1322")
       - Sorted by distance, not by run count
    5. Verify CITIES TABLE:
       - Shows ranked list of cities with columns: Rank, City, Country, Distance (km), Runs
       - Roskilde should be #1 (highest distance)
    6. Verify COVERAGE METADATA:
       - Shows text like "Based on 1,658 of 1,808 activities (92% with GPS data)"
    7. Test CSV EXPORT:
       - Click "Export CSV" button next to Countries heading
       - Verify a CSV file downloads with correct data
       - Open in Excel/text editor: check UTF-8 characters display correctly (e.g., "Sorø", "Chaniá")
       - Click "Export CSV" button next to Cities heading
       - Verify cities CSV downloads correctly
    8. Verify Shadow DOM ISOLATION:
       - Widget should use sans-serif font despite host page using Georgia serif
       - Widget styling should be self-contained
  </how-to-verify>
  <verify>Human confirms widget renders correctly with accurate data, working CSV export, and proper styling.</verify>
  <done>User has approved the widget's visual appearance, data accuracy, and CSV export functionality.</done>
  <resume-signal>Type "approved" or describe any issues with layout, data accuracy, or CSV export</resume-signal>
</task>

</tasks>

<verification>
- `npm run build` passes (TypeScript compilation)
- `npm run build-widgets` builds all 4 widgets without errors
- `dist/widgets/geo-stats-widget.iife.js` exists and is non-empty
- Widget renders on test-widgets.html with correct data
- Both CSV exports produce valid, well-formatted files
- Coverage metadata displays correctly
- All existing widgets continue working on test page
</verification>

<success_criteria>
1. Countries table visible with distance and run count, ranked by distance (GSTAT-01)
2. Cities table visible with distance and run count, ranked by distance (GSTAT-02)
3. CSV export works for both countries and cities with UTF-8 support (GSTAT-03)
4. Coverage metadata shows "X of Y activities (Z% with GPS data)" (success criteria #4)
5. Widget builds as IIFE bundle via build-widgets script
6. Widget follows Shadow DOM isolation pattern
7. All existing widgets unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/06-geographic-statistics/06-02-SUMMARY.md`
</output>

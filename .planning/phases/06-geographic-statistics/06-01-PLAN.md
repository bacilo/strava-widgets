---
phase: 06-geographic-statistics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/geo/compute-geo-stats.ts
  - data/geo/countries.json
  - data/geo/cities.json
  - data/geo/geo-metadata.json
autonomous: true
must_haves:
  truths:
    - "countries.json includes totalDistanceKm for each country, sorted by distance descending"
    - "cities.json includes totalDistanceKm for each city, sorted by distance descending"
    - "geo-metadata.json includes totalDistanceKm for all geocoded activities combined"
  artifacts:
    - path: "src/geo/compute-geo-stats.ts"
      provides: "Distance aggregation in geographic stats computation"
      contains: "totalDistanceKm"
    - path: "data/geo/countries.json"
      provides: "Country stats with distance data ranked by distance"
      contains: "totalDistanceKm"
    - path: "data/geo/cities.json"
      provides: "City stats with distance data ranked by distance"
      contains: "totalDistanceKm"
  key_links:
    - from: "src/geo/compute-geo-stats.ts"
      to: "StravaActivity.distance"
      via: "activity.distance field (meters) converted to km"
      pattern: "activity\\.distance"
---

<objective>
Extend geographic stats computation to aggregate total distance per country and city, and sort by distance.

Purpose: Phase 5 built the geocoding pipeline but only aggregated activity counts. Phase 6 success criteria require "total distance and run count per country/city, ranked by distance." This plan adds distance aggregation to the existing compute-geo-stats.ts script and regenerates the JSON output files.

Output: Updated countries.json and cities.json with totalDistanceKm field, sorted by distance descending. Updated geo-metadata.json with total distance.
</objective>

<execution_context>
@/Users/pedf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pedf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-geocoding-infrastructure/05-01-SUMMARY.md
@src/geo/compute-geo-stats.ts
@src/types/strava.types.ts
@data/geo/countries.json
@data/geo/cities.json
@data/geo/geo-metadata.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add distance aggregation to compute-geo-stats.ts</name>
  <files>src/geo/compute-geo-stats.ts</files>
  <action>
Modify `src/geo/compute-geo-stats.ts` to aggregate distance alongside activity counts:

1. **Update interfaces** at the top of the file:
   - `CountryStats`: Add `totalDistanceKm: number` field
   - `CityStats`: Add `totalDistanceKm: number` field
   - `GeoMetadata`: Add `totalDistanceKm: number` field

2. **Update aggregation maps** (countryMap and cityMap):
   - Add `totalDistanceM: number` to both map value types (accumulate in meters for precision, convert to km at output)
   - Initialize to 0 in both map defaults

3. **In the activity processing loop** (where `successCount++` is):
   - After incrementing activityCount, add: `existingCountry.totalDistanceM += activity.distance || 0;`
   - Same for city: `existingCity.totalDistanceM += activity.distance || 0;`
   - Track total distance: declare `let totalDistanceM = 0;` alongside totalCount/successCount, and add `totalDistanceM += activity.distance || 0;` after successCount++

4. **Update countries output** (Step 5):
   - Add `totalDistanceKm: Math.round((stats.totalDistanceM / 1000) * 10) / 10` to the map output (1 decimal place)
   - Change sort from `b.activityCount - a.activityCount` to `b.totalDistanceKm - a.totalDistanceKm` (ranked by distance)

5. **Update cities output** (Step 6):
   - Add `totalDistanceKm: Math.round((city.totalDistanceM / 1000) * 10) / 10` to the output
   - Change sort from `b.activityCount - a.activityCount` to `b.totalDistanceKm - a.totalDistanceKm`

6. **Update metadata** (Step 8):
   - Add `totalDistanceKm: Math.round((totalDistanceM / 1000) * 10) / 10` to the metadata object

7. **Update console summary** (Step 9):
   - Add a line: `console.log(\`- Total distance: \${(totalDistanceM / 1000).toFixed(1)} km\`);`

Note: `activity.distance` is in meters (per StravaActivity type). Convert to km by dividing by 1000. Use `|| 0` guard for any activities where distance might be undefined. Round to 1 decimal place for display (e.g., 15423.7 km).
  </action>
  <verify>
Run `npm run build` to confirm TypeScript compiles without errors. Then run `npm run compute-geo-stats` and verify:
1. Console output includes "Total distance: X km" line
2. `data/geo/countries.json` — first entry has `totalDistanceKm` field with a number > 0 and entries are sorted by totalDistanceKm descending
3. `data/geo/cities.json` — first entry has `totalDistanceKm` field with a number > 0 and entries are sorted by totalDistanceKm descending
4. `data/geo/geo-metadata.json` — includes `totalDistanceKm` field
5. All existing fields (countryName, countryIso2, activityCount, cities, cityName) are preserved
  </verify>
  <done>countries.json and cities.json contain totalDistanceKm for every entry, sorted by distance descending. geo-metadata.json includes totalDistanceKm. TypeScript compiles clean. Existing fields untouched.</done>
</task>

</tasks>

<verification>
- `npm run build` passes (TypeScript compilation)
- `npm run compute-geo-stats` completes successfully with distance in output
- `cat data/geo/countries.json | head -10` shows totalDistanceKm field, Denmark should be first (most distance)
- `cat data/geo/cities.json | head -10` shows totalDistanceKm field, Roskilde should be first
- `cat data/geo/geo-metadata.json` shows totalDistanceKm field with total > 0
- `npm run compute-all-stats` still completes successfully (geo stats integrated in pipeline)
</verification>

<success_criteria>
1. Every country entry in countries.json has totalDistanceKm > 0
2. Every city entry in cities.json has totalDistanceKm > 0
3. Countries sorted by totalDistanceKm descending (not activityCount)
4. Cities sorted by totalDistanceKm descending (not activityCount)
5. geo-metadata.json totalDistanceKm equals sum of all country distances (within rounding tolerance)
6. TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-geographic-statistics/06-01-SUMMARY.md`
</output>
